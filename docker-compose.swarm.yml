version: '3.8'

# =============================================================================
# ‚ö†Ô∏è DOCKER SWARM VERSION - Conex√£o de Sorte Traefik Infrastructure
# =============================================================================
# Este arquivo √© espec√≠fico para Docker Swarm deployment
# Baseado no docker-compose.yml principal com ajustes para Swarm
# =============================================================================

services:
  traefik:
    image: traefik:v3.5.2  # Latest stable

    # ==========================================================================
    # üì° PORTS
    # ==========================================================================
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      # Dashboard via HTTPS routing (sem porta externa 8080)
    networks:
      - conexao-network-swarm

    # ==========================================================================
    # üîß ENVIRONMENT VARIABLES
    # ==========================================================================
    environment:
      - TZ=${TZ:-America/Sao_Paulo}
      - TRAEFIK_ACME_EMAIL=${TRAEFIK_ACME_EMAIL:-facilitaservicos.tec@gmail.com}
      # Security
      - TRAEFIK_API_DASHBOARD=${ENABLE_DASHBOARD:-true}
      - TRAEFIK_API_INSECURE=${API_INSECURE:-false}
      # Performance
      - TRAEFIK_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TRAEFIK_ACCESSLOG=${ACCESS_LOG_ENABLED:-true}

    # ==========================================================================
    # üìÅ VOLUMES
    # ==========================================================================
    volumes:
      # Docker socket para service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Configura√ß√£o est√°tica principal
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro

      # Configura√ß√µes din√¢micas
      - ./traefik/dynamic:/etc/traefik/dynamic:ro

      # SSL/TLS certificates
      - ./letsencrypt:/letsencrypt

      # Logs (para auditoria)
      - ./logs/traefik:/var/log/traefik

      # Secrets para autentica√ß√£o
      - ./secrets:/secrets:ro

    # ==========================================================================
    # ü©∫ HEALTHCHECK
    # ==========================================================================
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # ==========================================================================
    # üè∑Ô∏è LABELS (Docker Swarm)
    # ==========================================================================
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      labels:
        # Habilitar Traefik para este servi√ßo
        - traefik.enable=true
        - traefik.docker.network=conexao-network-swarm

        # =======================================================================
        # üìä DASHBOARD HTTPS (sem porta externa)
        # =======================================================================
        - traefik.http.routers.dashboard.rule=Host(`${TRAEFIK_DOMAIN:-traefik.conexaodesorte.com.br}`)
        - traefik.http.routers.dashboard.entrypoints=websecure
        - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
        - traefik.http.routers.dashboard.service=api@internal

        # Dashboard com autentica√ß√£o
        - traefik.http.routers.dashboard.middlewares=dashboard-auth,security-headers

        # =======================================================================
        # üîê DASHBOARD AUTH
        # =======================================================================
        - traefik.http.middlewares.dashboard-auth.basicauth.usersfile=/secrets/traefik-basicauth

        # =======================================================================
        # üõ°Ô∏è SECURITY HEADERS
        # =======================================================================
        - traefik.http.middlewares.security-headers.headers.frameDeny=true
        - traefik.http.middlewares.security-headers.headers.sslRedirect=true
        - traefik.http.middlewares.security-headers.headers.browserXssFilter=true
        - traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true
        - traefik.http.middlewares.security-headers.headers.forceSTSHeader=true
        - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true
        - traefik.http.middlewares.security-headers.headers.stsPreload=true
        - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000

        # =======================================================================
        # üîÄ API BACKEND PROXY
        # =======================================================================
        - traefik.http.routers.api-backend.rule=Host(`${API_DOMAIN:-api.conexaodesorte.com.br}`)
        - traefik.http.routers.api-backend.entrypoints=websecure
        - traefik.http.routers.api-backend.tls.certresolver=letsencrypt
        - traefik.http.routers.api-backend.service=api-backend-service
        - traefik.http.services.api-backend-service.loadbalancer.server.port=${BACKEND_PORT:-8080}

        # CORS para API
        - traefik.http.routers.api-backend.middlewares=api-cors,security-headers

        # =======================================================================
        # üåê CORS MIDDLEWARE
        # =======================================================================
        - traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,OPTIONS,PUT,POST,DELETE,PATCH
        - traefik.http.middlewares.api-cors.headers.accessControlAllowOriginList=https://conexaodesorte.com.br,https://www.conexaodesorte.com.br
        - traefik.http.middlewares.api-cors.headers.accessControlMaxAge=100
        - traefik.http.middlewares.api-cors.headers.addVaryHeader=true
        - traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true
        - traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With

# =============================================================================
# üåê NETWORKS
# =============================================================================
networks:
  conexao-network-swarm:
    name: conexao-network-swarm
    external: true