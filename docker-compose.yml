services:
  traefik:
    image: traefik:v3.1
    container_name: traefik-microservices
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard
    environment:
      - TZ=America/Sao_Paulo
      - LETSENCRYPT_EMAIL=facilitaservicos.dev@gmail.com
    networks:
      - conexao-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./letsencrypt:/letsencrypt
      - ./secrets:/secrets:ro
    labels:
      - traefik.enable=true
      # Dashboard
      - traefik.http.routers.dashboard.rule=Host(`traefik.conexaodesorte.com.br`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
      - traefik.http.routers.dashboard.middlewares=admin-auth@file

  # ===== MICROSERVI√áOS =====
  
  # üîê Microservi√ßo de Autentica√ß√£o
  auth-microservice:
    image: ${AUTH_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-autenticacao:latest}
    container_name: conexao-auth-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8081
    labels:
      - traefik.enable=true
      # Subdominio dedicado
      - traefik.http.routers.auth-subdomain.rule=Host(`auth.conexaodesorte.com.br`)
      - traefik.http.routers.auth-subdomain.entrypoints=websecure
      - traefik.http.routers.auth-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.auth-subdomain.middlewares=security-headers@file,cors-api@file,rate-limit@file
      - traefik.http.routers.auth-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.auth-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/auth`)
      - traefik.http.routers.auth-path.entrypoints=websecure
      - traefik.http.routers.auth-path.tls.certresolver=letsencrypt
      - traefik.http.routers.auth-path.middlewares=auth-stripprefix@file,security-headers@file,cors-api@file
      - traefik.http.routers.auth-path.priority=200
      
      # Backward compatibility
      - traefik.http.routers.auth-legacy.rule=Host(`www.conexaodesorte.com.br`) && PathPrefix(`/rest/auth`)
      - traefik.http.routers.auth-legacy.entrypoints=websecure
      - traefik.http.routers.auth-legacy.tls.certresolver=letsencrypt
      - traefik.http.routers.auth-legacy.middlewares=auth-legacy-stripprefix@file,security-headers@file,cors-api@file
      - traefik.http.routers.auth-legacy.priority=300
      
      - traefik.http.services.auth.loadbalancer.server.port=8081
      - traefik.http.services.auth.loadbalancer.healthcheck.path=/actuator/health

  # üìä Microservi√ßo de Resultados
  results-microservice:
    image: ${RESULTS_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-resultados:latest}
    container_name: conexao-results-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8082
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.results-subdomain.rule=Host(`results.conexaodesorte.com.br`)
      - traefik.http.routers.results-subdomain.entrypoints=websecure
      - traefik.http.routers.results-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.results-subdomain.middlewares=security-headers@file,cors-api@file,cache-results@file
      - traefik.http.routers.results-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.results-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/results`)
      - traefik.http.routers.results-path.entrypoints=websecure
      - traefik.http.routers.results-path.tls.certresolver=letsencrypt
      - traefik.http.routers.results-path.middlewares=results-stripprefix@file,security-headers@file,cors-api@file
      - traefik.http.routers.results-path.priority=200
      
      # Legacy compatibility
      - traefik.http.routers.results-legacy.rule=Host(`www.conexaodesorte.com.br`) && PathPrefix(`/rest/resultados`)
      - traefik.http.routers.results-legacy.entrypoints=websecure
      - traefik.http.routers.results-legacy.tls.certresolver=letsencrypt
      - traefik.http.routers.results-legacy.middlewares=results-legacy-stripprefix@file,security-headers@file,cors-api@file
      - traefik.http.routers.results-legacy.priority=300
      
      - traefik.http.services.results.loadbalancer.server.port=8082
      - traefik.http.services.results.loadbalancer.healthcheck.path=/actuator/health

  # üí¨ Microservi√ßo de Bate-papo
  chat-microservice:
    image: ${CHAT_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-batepapo:latest}
    container_name: conexao-chat-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8079
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.chat-subdomain.rule=Host(`chat.conexaodesorte.com.br`)
      - traefik.http.routers.chat-subdomain.entrypoints=websecure
      - traefik.http.routers.chat-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.chat-subdomain.middlewares=security-headers@file,cors-api@file,websocket-headers@file
      - traefik.http.routers.chat-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.chat-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/chat`)
      - traefik.http.routers.chat-path.entrypoints=websecure
      - traefik.http.routers.chat-path.tls.certresolver=letsencrypt
      - traefik.http.routers.chat-path.middlewares=chat-stripprefix@file,security-headers@file,cors-api@file
      - traefik.http.routers.chat-path.priority=200
      
      - traefik.http.services.chat.loadbalancer.server.port=8083
      - traefik.http.services.chat.loadbalancer.healthcheck.path=/actuator/health

  # üì¢ Microservi√ßo de Notifica√ß√µes
  notifications-microservice:
    image: ${NOTIFICATIONS_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-notificacoes:latest}
    container_name: conexao-notifications-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8084
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.notifications-subdomain.rule=Host(`notifications.conexaodesorte.com.br`)
      - traefik.http.routers.notifications-subdomain.entrypoints=websecure
      - traefik.http.routers.notifications-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.notifications-subdomain.middlewares=security-headers@file,cors-api@file,rate-limit-notifications@file
      - traefik.http.routers.notifications-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.notifications-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/notifications`)
      - traefik.http.routers.notifications-path.entrypoints=websecure
      - traefik.http.routers.notifications-path.tls.certresolver=letsencrypt
      - traefik.http.routers.notifications-path.middlewares=notifications-stripprefix@file,security-headers@file,cors-api@file
      - traefik.http.routers.notifications-path.priority=200
      
      - traefik.http.services.notifications.loadbalancer.server.port=8084
      - traefik.http.services.notifications.loadbalancer.healthcheck.path=/actuator/health

  # üìã Microservi√ßo de Auditoria
  audit-microservice:
    image: ${AUDIT_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-auditoria-compliance:latest}
    container_name: conexao-audit-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8085
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.audit-subdomain.rule=Host(`audit.conexaodesorte.com.br`)
      - traefik.http.routers.audit-subdomain.entrypoints=websecure
      - traefik.http.routers.audit-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.audit-subdomain.middlewares=security-headers@file,cors-api@file,audit-auth@file
      - traefik.http.routers.audit-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.audit-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/audit`)
      - traefik.http.routers.audit-path.entrypoints=websecure
      - traefik.http.routers.audit-path.tls.certresolver=letsencrypt
      - traefik.http.routers.audit-path.middlewares=audit-stripprefix@file,security-headers@file,cors-api@file,audit-auth@file
      - traefik.http.routers.audit-path.priority=200
      
      - traefik.http.services.audit.loadbalancer.server.port=8085
      - traefik.http.services.audit.loadbalancer.healthcheck.path=/actuator/health

  # üìà Microservi√ßo de Observabilidade
  observability-microservice:
    image: ${OBSERVABILITY_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-observabilidade:latest}
    container_name: conexao-observability-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8086
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.monitoring-subdomain.rule=Host(`monitoring.conexaodesorte.com.br`)
      - traefik.http.routers.monitoring-subdomain.entrypoints=websecure
      - traefik.http.routers.monitoring-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.monitoring-subdomain.middlewares=security-headers@file,admin-auth@file
      - traefik.http.routers.monitoring-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.monitoring-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/monitoring`)
      - traefik.http.routers.monitoring-path.entrypoints=websecure
      - traefik.http.routers.monitoring-path.tls.certresolver=letsencrypt
      - traefik.http.routers.monitoring-path.middlewares=monitoring-stripprefix@file,security-headers@file,admin-auth@file
      - traefik.http.routers.monitoring-path.priority=200
      
      - traefik.http.services.monitoring.loadbalancer.server.port=8086
      - traefik.http.services.monitoring.loadbalancer.healthcheck.path=/actuator/health

  # ‚è∞ Microservi√ßo de Scheduler
  scheduler-microservice:
    image: ${SCHEDULER_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-scheduler:latest}
    container_name: conexao-scheduler-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8087
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.scheduler-subdomain.rule=Host(`scheduler.conexaodesorte.com.br`)
      - traefik.http.routers.scheduler-subdomain.entrypoints=websecure
      - traefik.http.routers.scheduler-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.scheduler-subdomain.middlewares=security-headers@file,admin-auth@file
      - traefik.http.routers.scheduler-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.scheduler-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/scheduler`)
      - traefik.http.routers.scheduler-path.entrypoints=websecure
      - traefik.http.routers.scheduler-path.tls.certresolver=letsencrypt
      - traefik.http.routers.scheduler-path.middlewares=scheduler-stripprefix@file,security-headers@file,admin-auth@file
      - traefik.http.routers.scheduler-path.priority=200
      
      - traefik.http.services.scheduler.loadbalancer.server.port=8087
      - traefik.http.services.scheduler.loadbalancer.healthcheck.path=/actuator/health

  # üîê Microservi√ßo de Criptografia
  crypto-microservice:
    image: ${CRYPTO_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-criptografia:latest}
    container_name: conexao-crypto-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8089
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.crypto-subdomain.rule=Host(`crypto.conexaodesorte.com.br`)
      - traefik.http.routers.crypto-subdomain.entrypoints=websecure
      - traefik.http.routers.crypto-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.crypto-subdomain.middlewares=security-headers@file,crypto-auth@file,rate-limit-strict@file
      - traefik.http.routers.crypto-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.crypto-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/crypto`)
      - traefik.http.routers.crypto-path.entrypoints=websecure
      - traefik.http.routers.crypto-path.tls.certresolver=letsencrypt
      - traefik.http.routers.crypto-path.middlewares=crypto-stripprefix@file,security-headers@file,crypto-auth@file,rate-limit-strict@file
      - traefik.http.routers.crypto-path.priority=200
      
      - traefik.http.services.crypto.loadbalancer.server.port=8089
      - traefik.http.services.crypto.loadbalancer.healthcheck.path=/actuator/health

  # üîë Microservi√ßo de Criptografia KMS
  crypto-kms-microservice:
    image: ${CRYPTO_KMS_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-criptografia-kms:latest}
    container_name: conexao-crypto-kms-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8084
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.crypto-kms-subdomain.rule=Host(`crypto-kms.conexaodesorte.com.br`)
      - traefik.http.routers.crypto-kms-subdomain.entrypoints=websecure
      - traefik.http.routers.crypto-kms-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.crypto-kms-subdomain.middlewares=security-headers@file,crypto-auth@file,rate-limit-strict@file
      - traefik.http.routers.crypto-kms-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.crypto-kms-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/crypto-kms`)
      - traefik.http.routers.crypto-kms-path.entrypoints=websecure
      - traefik.http.routers.crypto-kms-path.tls.certresolver=letsencrypt
      - traefik.http.routers.crypto-kms-path.middlewares=crypto-kms-stripprefix@file,security-headers@file,crypto-auth@file,rate-limit-strict@file
      - traefik.http.routers.crypto-kms-path.priority=200
      
      - traefik.http.services.crypto-kms.loadbalancer.server.port=8084
      - traefik.http.services.crypto-kms.loadbalancer.healthcheck.path=/actuator/health

  # üîç Microservi√ßo de Observabilidade Diagn√≥stico
  observability-diagnostics-microservice:
    image: ${OBSERVABILITY_DIAG_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-observabilidade-diagnostico:latest}
    container_name: conexao-observability-diag-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8086
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.monitoring-diag-subdomain.rule=Host(`monitoring-diag.conexaodesorte.com.br`)
      - traefik.http.routers.monitoring-diag-subdomain.entrypoints=websecure
      - traefik.http.routers.monitoring-diag-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.monitoring-diag-subdomain.middlewares=security-headers@file,admin-auth@file
      - traefik.http.routers.monitoring-diag-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.monitoring-diag-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/monitoring-diag`)
      - traefik.http.routers.monitoring-diag-path.entrypoints=websecure
      - traefik.http.routers.monitoring-diag-path.tls.certresolver=letsencrypt
      - traefik.http.routers.monitoring-diag-path.middlewares=monitoring-diag-stripprefix@file,security-headers@file,admin-auth@file
      - traefik.http.routers.monitoring-diag-path.priority=200
      
      - traefik.http.services.monitoring-diag.loadbalancer.server.port=8086
      - traefik.http.services.monitoring-diag.loadbalancer.healthcheck.path=/actuator/health

  # üìÖ Microservi√ßo de Scheduler Extra√ß√µes
  scheduler-extractions-microservice:
    image: ${SCHEDULER_EXTRACTIONS_IMAGE:-ghcr.io/wibson82/conexao-de-sorte-backend-scheduler-extracoes:latest}
    container_name: conexao-scheduler-extractions-ms
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - SPRING_PROFILES_ACTIVE=prod,azure
      - SERVER_PORT=8088
    labels:
      - traefik.enable=true
      # Subdominio
      - traefik.http.routers.scheduler-extractions-subdomain.rule=Host(`scheduler-extractions.conexaodesorte.com.br`)
      - traefik.http.routers.scheduler-extractions-subdomain.entrypoints=websecure
      - traefik.http.routers.scheduler-extractions-subdomain.tls.certresolver=letsencrypt
      - traefik.http.routers.scheduler-extractions-subdomain.middlewares=security-headers@file,admin-auth@file
      - traefik.http.routers.scheduler-extractions-subdomain.priority=100
      
      # Path API
      - traefik.http.routers.scheduler-extractions-path.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/scheduler-extractions`)
      - traefik.http.routers.scheduler-extractions-path.entrypoints=websecure
      - traefik.http.routers.scheduler-extractions-path.tls.certresolver=letsencrypt
      - traefik.http.routers.scheduler-extractions-path.middlewares=scheduler-extractions-stripprefix@file,security-headers@file,admin-auth@file
      - traefik.http.routers.scheduler-extractions-path.priority=200
      
      - traefik.http.services.scheduler-extractions.loadbalancer.server.port=8088
      - traefik.http.services.scheduler-extractions.loadbalancer.healthcheck.path=/actuator/health

  # üåê Frontend Web
  frontend-web:
    image: ${FRONTEND_IMAGE:-facilita/conexao-frontend:latest}
    container_name: conexao-frontend-web
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - NODE_ENV=production
      - API_BASE_URL=https://api.conexaodesorte.com.br
      - NEXT_PUBLIC_API_URL=https://api.conexaodesorte.com.br
      - PORT=3000
    labels:
      - traefik.enable=true
      # www domain
      - traefik.http.routers.frontend-www.rule=Host(`www.conexaodesorte.com.br`)
      - traefik.http.routers.frontend-www.entrypoints=websecure
      - traefik.http.routers.frontend-www.tls.certresolver=letsencrypt
      - traefik.http.routers.frontend-www.middlewares=security-headers@file,gzip@file
      - traefik.http.routers.frontend-www.priority=10
      # apex domain redirect
      - traefik.http.routers.frontend-apex.rule=Host(`conexaodesorte.com.br`)
      - traefik.http.routers.frontend-apex.entrypoints=websecure
      - traefik.http.routers.frontend-apex.tls.certresolver=letsencrypt
      - traefik.http.routers.frontend-apex.middlewares=www-redirect@file
      - traefik.http.routers.frontend-apex.priority=5
      - traefik.http.services.frontend.loadbalancer.server.port=3000
networks:
  conexao-network:
    name: conexao-network
    external: true
