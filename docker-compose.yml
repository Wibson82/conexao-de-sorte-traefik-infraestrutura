services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=America/Sao_Paulo
      - LETSENCRYPT_EMAIL=facilitaservicos.dev@gmail.com
    networks:
      - conexao-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic:/dynamic:ro
      - ./letsencrypt:/letsencrypt
      - ./secrets:/secrets:ro
    labels:
      - traefik.enable=true
      # Dashboard seguro
      - traefik.http.routers.dashboard.rule=Host(`traefik.conexaodesorte.com.br`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.middlewares.dashboard-auth.basicauth.usersfile=/secrets/traefik-basicauth
      - traefik.http.routers.dashboard.middlewares=dashboard-auth,security-headers@file

  # Frontend Web - Conexão de Sorte
  frontend-web:
    image: ${FRONTEND_IMAGE:-facilita/conexao-de-sorte-frontend:latest}
    container_name: conexao-frontend
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - NODE_ENV=production
      - API_BASE_URL=https://www.conexaodesorte.com.br/rest
      - NEXT_PUBLIC_API_URL=https://www.conexaodesorte.com.br/rest
      - PORT=3000
    labels:
      - traefik.enable=true
      # Roteamento para domínio principal
      # Rota principal (sem www)
      - traefik.http.routers.frontend-main.rule=Host(`conexaodesorte.com.br`)
      - traefik.http.routers.frontend-main.entrypoints=websecure
      - traefik.http.routers.frontend-main.tls.certresolver=letsencrypt
      - traefik.http.routers.frontend-main.middlewares=security-headers@file,gzip-compress@file
      - traefik.http.routers.frontend-main.priority=1
      # Rota com www (redirecionamento)
      - traefik.http.routers.frontend-www.rule=Host(`www.conexaodesorte.com.br`)
      - traefik.http.routers.frontend-www.entrypoints=websecure
      - traefik.http.routers.frontend-www.tls.certresolver=letsencrypt
      - traefik.http.routers.frontend-www.middlewares=redirect-www-to-non-www@file
      - traefik.http.routers.frontend-www.priority=1
      - traefik.http.services.frontend.loadbalancer.server.port=3000

networks:
  conexao-network:
    external: true
