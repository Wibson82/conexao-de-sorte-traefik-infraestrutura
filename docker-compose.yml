services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=America/Sao_Paulo
      - LETSENCRYPT_EMAIL=facilitaservicos.dev@gmail.com
    networks:
      - conexao-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic:/dynamic:ro
      - ./letsencrypt:/letsencrypt
      - ./secrets:/secrets:ro
    labels:
      - traefik.enable=true
      # Dashboard seguro
      - traefik.http.routers.dashboard.rule=Host(`traefik.conexaodesorte.com.br`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.middlewares.dashboard-auth.basicauth.usersfile=/secrets/traefik-basicauth
      - traefik.http.routers.dashboard.middlewares=dashboard-auth,security-headers@file

  # Frontend Web - Conexão de Sorte
  frontend-web:
    image: ${FRONTEND_IMAGE:-facilita/conexao-de-sorte-frontend:latest}
    container_name: conexao-frontend
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - NODE_ENV=production
      - API_BASE_URL=https://www.conexaodesorte.com.br/rest
      - NEXT_PUBLIC_API_URL=https://www.conexaodesorte.com.br/rest
      - PORT=3000
    labels:
      - traefik.enable=true
      # Roteamento para domínio principal (sem www)
      - traefik.http.routers.frontend-main.rule=Host(`conexaodesorte.com.br`)
      - traefik.http.routers.frontend-main.entrypoints=websecure
      - traefik.http.routers.frontend-main.tls.certresolver=letsencrypt
      - traefik.http.routers.frontend-main.middlewares=security-headers@file,gzip-compress@file
      - traefik.http.routers.frontend-main.priority=1
      # Roteamento para domínio com www
      - traefik.http.routers.frontend-www.rule=Host(`www.conexaodesorte.com.br`)
      - traefik.http.routers.frontend-www.entrypoints=websecure
      - traefik.http.routers.frontend-www.tls.certresolver=letsencrypt
      - traefik.http.routers.frontend-www.middlewares=security-headers@file,gzip-compress@file
      - traefik.http.routers.frontend-www.priority=1
      - traefik.http.services.frontend.loadbalancer.server.port=3000


  # Backend Produção - Ambiente de Produção
  backend-prod:
    image: ${BACKEND_PROD_IMAGE:-facilita/conexao-de-sorte-backend:latest}
    container_name: conexao-backend-prod
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${PROD_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=${PROD_REDIS_URL}
      - PORT=8080
    labels:
      - traefik.enable=true
      # Roteamento para APIs de produção (sem www)
      - traefik.http.routers.backend-prod-main.rule=Host(`conexaodesorte.com.br`) && PathPrefix(`/rest`)
      - traefik.http.routers.backend-prod-main.entrypoints=websecure
      - traefik.http.routers.backend-prod-main.tls.certresolver=letsencrypt
      - traefik.http.routers.backend-prod-main.middlewares=security-headers-api@file,gzip-compress@file,cors-api@file
      - traefik.http.routers.backend-prod-main.priority=100
      # Roteamento para APIs de produção (com www)
      - traefik.http.routers.backend-prod-www.rule=Host(`www.conexaodesorte.com.br`) && PathPrefix(`/rest`)
      - traefik.http.routers.backend-prod-www.entrypoints=websecure
      - traefik.http.routers.backend-prod-www.tls.certresolver=letsencrypt
      - traefik.http.routers.backend-prod-www.middlewares=security-headers-api@file,gzip-compress@file,cors-api@file
      - traefik.http.routers.backend-prod-www.priority=100
      - traefik.http.services.backend-prod.loadbalancer.server.port=8080

  # Backend Teste - Ambiente de Testes
  backend-teste:
    image: ${BACKEND_TEST_IMAGE:-conexao-de-sorte-test:latest}
    container_name: conexao-backend-teste
    restart: unless-stopped
    networks:
      - conexao-network
    environment:
      - NODE_ENV=test
      - DATABASE_URL=${TEST_DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=${TEST_REDIS_URL}
      - PORT=8081
    labels:
      - traefik.enable=true
      # Roteamento para APIs de teste (sem www)
      - traefik.http.routers.backend-teste-main.rule=Host(`conexaodesorte.com.br`) && PathPrefix(`/teste/rest`)
      - traefik.http.routers.backend-teste-main.entrypoints=websecure
      - traefik.http.routers.backend-teste-main.tls.certresolver=letsencrypt
      - traefik.http.routers.backend-teste-main.middlewares=security-headers-api@file,gzip-compress@file,cors-api@file,rate-limit-strict@file
      - traefik.http.routers.backend-teste-main.priority=200
      # Roteamento para APIs de teste (com www)
      - traefik.http.routers.backend-teste-www.rule=Host(`www.conexaodesorte.com.br`) && PathPrefix(`/teste/rest`)
      - traefik.http.routers.backend-teste-www.entrypoints=websecure
      - traefik.http.routers.backend-teste-www.tls.certresolver=letsencrypt
      - traefik.http.routers.backend-teste-www.middlewares=security-headers-api@file,gzip-compress@file,cors-api@file,rate-limit-strict@file
      - traefik.http.routers.backend-teste-www.priority=200
      - traefik.http.services.backend-teste.loadbalancer.server.port=8081
networks:
  conexao-network:
    external: true
