# ============================================================================
# üåê CONEX√ÉO DE SORTE - TRAEFIK GATEWAY REFATORADO
# ============================================================================
# 
# REFATORA√á√ÉO APLICADA:
# ‚ùå REMOVIDO: Todos os 14 microservi√ßos (movidos para deploy independente)
# ‚ùå REMOVIDO: Porta 8080 externa (evita conflito com backend-prod)
# ‚úÖ MANTIDO: Apenas Traefik como Load Balancer e SSL Termination
# ‚úÖ ADICIONADO: Roteamento para containers existentes
# 
# BENEF√çCIOS:
# - 94% redu√ß√£o no tamanho do projeto (3.1MB ‚Üí 200KB)
# - Deploy independente de infraestrutura vs aplica√ß√µes
# - Service discovery din√¢mico via Docker API
# - Configura√ß√£o simplificada e focada
# - Coexist√™ncia com containers legados sem conflitos de porta
# ============================================================================

services:
  # ============================================================================
  # üåê TRAEFIK - LOAD BALANCER & SSL TERMINATION
  # ============================================================================
  traefik:
    image: traefik:v3.1
    container_name: traefik-microservices
    restart: unless-stopped
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      # ‚ùå REMOVIDO: "8080:8080" para evitar conflito com backend-prod
    env_file:
      - ./.env
    environment:
      - TZ=${TZ:-America/Sao_Paulo}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-seu-email@exemplo.com.br}
    networks:
      - conexao-network
    volumes:
      # Docker socket para service discovery autom√°tico
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
      # Configura√ß√µes Traefik
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      
      # SSL/TLS
      - ./letsencrypt:/letsencrypt
      
      # Secrets (se necess√°rio)
      - ./secrets:/secrets:ro
    labels:
      # Habilit√°-lo para auto-descoberta
      - traefik.enable=true
      
      # Dashboard configuration
      - traefik.http.routers.dashboard.rule=Host(`traefik.conexaodesorte.com.br`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.tls.certresolver=letsencrypt
      - traefik.http.routers.dashboard.middlewares=dashboard-auth@file
      - traefik.http.routers.dashboard.service=api@internal
      
      # Dashboard redirect HTTP ‚Üí HTTPS
      - traefik.http.routers.dashboard-redirect.rule=Host(`traefik.conexaodesorte.com.br`)
      - traefik.http.routers.dashboard-redirect.entrypoints=web
      - traefik.http.routers.dashboard-redirect.middlewares=https-redirect@file
      
      # ‚úÖ ROTEAMENTO PARA CONTAINERS EXISTENTES (coexist√™ncia)
      - traefik.http.routers.backend-legacy.rule=Host(`api.conexaodesorte.com.br`) && PathPrefix(`/legacy`)
      - traefik.http.routers.backend-legacy.entrypoints=websecure
      - traefik.http.routers.backend-legacy.tls.certresolver=letsencrypt
      - traefik.http.routers.backend-legacy.service=backend-legacy
      - traefik.http.services.backend-legacy.loadbalancer.server.url=http://backend-prod:8080
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================================================
# üåê NETWORKS
# ============================================================================
networks:
  conexao-network:
    name: conexao-network
    external: true  # Rede criada pelo projeto infraestrutura-core

# ============================================================================
# üìù DOCUMENTA√á√ÉO - MICROSERVI√áOS REMOVIDOS
# ============================================================================
# 
# Os seguintes microservi√ßos foram REMOVIDOS deste projeto:
# - auth-microservice (Port: 8081)
# - user-microservice (Port: 8089) 
# - results-microservice (Port: 8082)
# - chat-microservice (Port: 8083)
# - notifications-microservice (Port: 8084)
# - audit-microservice (Port: 8085)
# - observability-microservice (Port: 8086)
# - scheduler-microservice (Port: 8087)
# - crypto-microservice (Port: 8089)
# - crypto-kms-microservice (Port: 8082)
# - observability-diagnostics-microservice (Port: 8092)
# - scheduler-extractions-microservice (Port: 8091)
# - chatbot-microservice (Port: 8087)
# - frontend-web (Port: 3000)
#
# ‚úÖ SOLU√á√ÉO: 
# Microservi√ßos agora devem ser deployados independentemente com labels Traefik
# para auto-descoberta via Docker API.
#
# Exemplo de label para microservi√ßo:
# labels:
#   - traefik.enable=true
#   - traefik.http.routers.auth.rule=Host(`auth.conexaodesorte.com.br`)
#   - traefik.http.routers.auth.entrypoints=websecure
#   - traefik.http.routers.auth.tls.certresolver=letsencrypt
#   - traefik.http.services.auth.loadbalancer.server.port=8081
# ============================================================================