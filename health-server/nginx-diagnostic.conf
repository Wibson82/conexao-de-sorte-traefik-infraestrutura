# =============================================================================
# 游깷 NGINX CONFIGURA칂츾O PARA ENDPOINT DE DIAGN칍STICO
# =============================================================================
# Serve diagn칩stico completo via /rest/v1/log-servidor
# P칰blico, sem autentica칞칚o, acess칤vel via curl/Postman/navegador
# =============================================================================

server {
    listen 9090;
    server_name localhost;

    # Headers de seguran칞a b치sicos
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

    # Endpoint principal - diagn칩stico JSON
    location /rest/v1/log-servidor {
        add_header Content-Type "application/json" always;

        # Se arquivo JSON existir, servir
        if (-f /tmp/diagnostic/diagnostic.json) {
            rewrite ^.*$ /diagnostic.json last;
        }

        # Caso contr치rio, gerar diagn칩stico na hora
        return 200 '{"error": "Diagn칩stico sendo gerado...", "timestamp": "$time_iso8601", "retry_in": "30 segundos"}';
    }

    # Servir arquivo JSON gerado
    location /diagnostic.json {
        alias /tmp/diagnostic/diagnostic.json;
        add_header Content-Type "application/json" always;
    }

    # Vers칚o HTML para navegador
    location /diagnostic.html {
        alias /tmp/diagnostic/diagnostic.html;
        add_header Content-Type "text/html" always;
    }

    # Health check simples
    location /health {
        add_header Content-Type "application/json" always;
        return 200 '{"status": "healthy", "timestamp": "$time_iso8601", "service": "diagnostic-server"}';
    }

    # P치gina inicial com informa칞칫es
    location / {
        add_header Content-Type "text/html" always;
        return 200 '<!DOCTYPE html>
        <html>
        <head><title>Diagnostic Server - Conex칚o de Sorte</title></head>
        <body style="font-family: monospace; margin: 40px; background: #1e1e1e; color: #d4d4d4;">
            <h1>游댌 Servidor de Diagn칩stico</h1>
            <h2>Endpoints Dispon칤veis:</h2>
            <ul>
                <li><a href="/rest/v1/log-servidor" style="color: #569cd6;">/rest/v1/log-servidor</a> - Diagn칩stico JSON completo</li>
                <li><a href="/diagnostic.html" style="color: #569cd6;">/diagnostic.html</a> - Vers칚o HTML visual</li>
                <li><a href="/health" style="color: #569cd6;">/health</a> - Health check</li>
            </ul>
            <h2>Acesso:</h2>
            <pre style="background: #2d2d30; padding: 10px; border-radius: 5px;">
# Via curl/Postman
curl https://conexaodesorte.com.br/rest/v1/log-servidor

# Direto por IP
curl http://145.223.31.87/rest/v1/log-servidor
            </pre>
            <p><strong>P칰blico</strong> - Sem autentica칞칚o necess치ria</p>
            <p><em>Atualizado automaticamente a cada 30 segundos</em></p>
        </body>
        </html>';
    }

    # Logs
    access_log /var/log/nginx/diagnostic_access.log;
    error_log /var/log/nginx/diagnostic_error.log;
}