name: "ðŸ—ï¸ Infrastructure Component - CI/CD Pipeline"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  INFRA_TYPE: infrastructure
  KUBECTL_VERSION: 'v1.28.0'

permissions:
  contents: read
  security-events: write

jobs:
  validate:
    name: "ðŸ” Validate Infrastructure Component"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ”§ Setup kubectl"
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}
          
      - name: "ðŸ“‹ Validate YAML Files"
        run: |
          echo "ðŸ“‹ Validating YAML syntax..."
          yaml_count=0
          for file in $(find . -name "*.yaml" -o -name "*.yml" | grep -v ".github"); do
            echo "Validating: $file"
            yaml_count=$((yaml_count + 1))
            if ! kubectl --dry-run=client apply -f "$file" 2>/dev/null; then
              echo "âš ï¸ Warning: $file may have issues (this is normal for templates)"
            fi
          done
          echo "âœ… Validated $yaml_count YAML files"
          
      - name: "ðŸ”’ Security Validation"
        run: |
          echo "ðŸ”’ Checking for security issues..."

          # Simple and focused security check
          echo "ðŸ“‹ Checking for obvious security issues..."

          # Check for extremely dangerous patterns only
          dangerous_patterns_found=false

          if find . -name "*.yaml" -o -name "*.yml" | grep -v "\.github" | xargs grep -i "password: admin" 2>/dev/null; then
            echo "âŒ Found 'password: admin' - extremely dangerous!"
            dangerous_patterns_found=true
          fi

          if find . -name "*.yaml" -o -name "*.yml" | grep -v "\.github" | xargs grep -i "password: root" 2>/dev/null; then
            echo "âŒ Found 'password: root' - extremely dangerous!"
            dangerous_patterns_found=true
          fi

          if find . -name "*.yaml" -o -name "*.yml" | grep -v "\.github" | xargs grep -i "password: 123456" 2>/dev/null; then
            echo "âŒ Found 'password: 123456' - extremely dangerous!"
            dangerous_patterns_found=true
          fi

          if [[ "$dangerous_patterns_found" == "true" ]]; then
            echo "âŒ Critical security issues found!"
            exit 1
          fi

          echo "âœ… Security validation passed - no critical issues found"
          
      - name: "ðŸ§ª Test Scripts"
        run: |
          echo "ðŸ§ª Testing executable scripts..."
          
          script_count=0
          for script in $(find . -name "*.sh"); do
            echo "Testing: $script"
            script_count=$((script_count + 1))
            if ! bash -n "$script"; then
              echo "âŒ Syntax error in $script"
              exit 1
            fi
          done
          
          if [ $script_count -eq 0 ]; then
            echo "â„¹ï¸ No shell scripts found"
          else
            echo "âœ… All $script_count scripts have valid syntax"
          fi
          
      - name: "ðŸ“‹ Validate Documentation"
        run: |
          echo "ðŸ“‹ Checking documentation..."
          
          if [ ! -f "README.md" ]; then
            echo "âŒ README.md not found"
            exit 1
          fi
          
          if [ ! -f ".gitignore" ]; then
            echo "âš ï¸ .gitignore not found"
          fi
          
          echo "âœ… Documentation validation passed"
          
      - name: "ðŸ“Š Generate Report"
        run: |
          echo "ðŸ“Š Infrastructure Component Validation Report"
          echo "=================================================="
          echo "Project: conexao-de-sorte-traefik-infraestrutura"
          echo "Type: infrastructure"
          echo "YAML files: $(find . -name "*.yaml" -o -name "*.yml" | grep -v ".github" | wc -l)"
          echo "Scripts: $(find . -name "*.sh" | wc -l)"
          echo "Status: âœ… Validation Passed"

  # ============================================================================
  # ðŸš€ DEPLOY JOB - SELF-HOSTED RUNNER
  # ============================================================================
  deploy-selfhosted:
    name: "ðŸš€ Deploy to Self-Hosted Server"
    runs-on: [self-hosted, Linux, X64, conexao-de-sorte-traefik-infraestrutura]
    needs: [validate]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ³ Deploy Traefik Infrastructure"
        run: |
          echo "ðŸš€ Deploying Traefik Infrastructure with Log Server..."

          # Build log server image for Swarm
          echo "ðŸ—ï¸ Building Log Server image..."
          docker build -t log-server:latest -f health-server/Dockerfile .

          # Stop existing services safely
          echo "â¹ï¸ Stopping existing Traefik services..."
          docker service ls --filter name=traefik-stack --format "{{.Name}}" | xargs -r docker service rm || true
          sleep 10

          # Remove orphaned containers
          echo "ðŸ§¹ Cleaning up containers..."
          docker ps -a --filter name=traefik --format "{{.ID}}" | xargs -r docker rm -f || true

          # Deploy the stack with log server
          echo "ðŸ—ï¸ Deploying Traefik stack with Log Server..."
          docker stack deploy -c docker-compose.yml traefik-stack --with-registry-auth

          # Wait for services to start
          echo "â³ Waiting for services to initialize..."
          sleep 30

          # Verify deployment
          echo "ðŸ” Verifying deployment..."
          docker service ls --filter name=traefik-stack

          # Check health of critical services
          echo "ðŸ¥ Checking service health..."
          for service in traefik log-server health-monitor; do
            if docker service ls --filter name=traefik-stack_${service} --format "{{.Name}}" | grep -q .; then
              echo "âœ… Service ${service} deployed"
            else
              echo "âš ï¸ Service ${service} not found"
            fi
          done

      - name: "ðŸ“Š Post-Deploy Verification"
        run: |
          echo "ðŸ“Š Post-deployment verification..."

          # Wait a bit more for health checks
          sleep 60

          # Validate deployment on self-hosted server
          echo "ðŸ—ï¸ Validating deployment on self-hosted runner:"
          echo "ðŸ“ Runner: ${{ runner.name }}"
          echo "ðŸ“ OS: ${{ runner.os }}"
          echo "ðŸ“ Architecture: ${{ runner.arch }}"

          # Check running containers
          echo "ðŸ³ Running containers on server:"
          docker ps --filter name=traefik-stack --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

          # Validate Docker Swarm services
          echo "ðŸ” Docker Swarm services:"
          docker service ls --filter name=traefik-stack

          # Count deployed services
          service_count=$(docker service ls --filter name=traefik-stack --quiet | wc -l)
          echo "ðŸ“Š Total services deployed: $service_count"

          if [[ $service_count -gt 0 ]]; then
            echo "âœ… Services successfully deployed to self-hosted server!"
          else
            echo "âŒ No services found - deployment may have failed"
            exit 1
          fi

          # Test critical endpoints (if accessible locally on runner)
          echo "ðŸŒ Testing endpoints on runner..."

          # Test log server health
          if curl -f http://localhost:9090/health 2>/dev/null; then
            echo "âœ… Log server health endpoint responding on runner"
          else
            echo "âš ï¸ Log server not accessible on runner port 9090"
          fi

          # Check if Traefik is binding ports
          if netstat -tlnp 2>/dev/null | grep -E ':80|:443' | head -3; then
            echo "âœ… Traefik ports (80/443) are bound on server"
          else
            echo "âš ï¸ Traefik ports not detected (may be starting up)"
          fi

          echo "ðŸŽ‰ Deployment verification completed on server runner!"
          echo "ðŸŒ Services should be accessible via: conexaodesorte.com.br"

  summary:
    name: "ðŸ“Š Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [validate, deploy-selfhosted]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: "ðŸ“Š Generate Summary"
        run: |
          echo "## ðŸ—ï¸ Infrastructure Component Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy-selfhosted.result == 'success' && 'âœ… Deployed' || needs.deploy-selfhosted.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** conexao-de-sorte-traefik-infraestrutura" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
