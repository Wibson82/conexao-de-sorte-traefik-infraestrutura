name: CI - ValidaÃ§Ã£o e Testes

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # =============================================================================
  # VALIDAÃ‡ÃƒO DE CONFIGURAÃ‡Ã•ES
  # =============================================================================
  validate-configs:
    name: ğŸ” Validar ConfiguraÃ§Ãµes
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”§ Validar sintaxe YAML
      run: |
        # Instalar yamllint
        pip install yamllint
        
        # Validar todos os arquivos YAML
        find . -name "*.yml" -o -name "*.yaml" | xargs yamllint -d relaxed
        
    - name: ğŸ” Validar configuraÃ§Ãµes Traefik
      run: |
        # Criar container temporÃ¡rio para validaÃ§Ã£o
        docker run --rm \
          -v "$PWD/config:/etc/traefik:ro" \
          -v "$PWD/dynamic:/etc/traefik/dynamic:ro" \
          traefik:v3.0 \
          traefik --configfile=/etc/traefik/traefik.yml --dry-run
          
    - name: ğŸ§ª Testar docker-compose
      run: |
        # Validar sintaxe do docker-compose
        docker-compose config
        
        # Verificar se todos os serviÃ§os podem ser criados
        docker-compose config --services

  # =============================================================================
  # TESTES DE CONECTIVIDADE
  # =============================================================================
  connectivity-tests:
    name: ğŸŒ Testes de Conectividade
    runs-on: ubuntu-latest
    needs: validate-configs
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸš€ Iniciar serviÃ§os de teste
      run: |
        # Criar rede de teste
        docker network create traefik-test || true
        
        # Iniciar Traefik em modo de teste
        docker run -d --name traefik-test \
          --network traefik-test \
          -p 8080:8080 \
          -p 80:80 \
          -v "$PWD/config:/etc/traefik:ro" \
          -v "$PWD/dynamic:/etc/traefik/dynamic:ro" \
          -v /var/run/docker.sock:/var/run/docker.sock:ro \
          traefik:v3.0
          
        # Aguardar Traefik inicializar
        sleep 10
        
    - name: ğŸ” Testar dashboard Traefik
      run: |
        # Testar se o dashboard estÃ¡ acessÃ­vel
        curl -f http://localhost:8080/api/rawdata || exit 1
        curl -f http://localhost:8080/dashboard/ || exit 1
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        docker stop traefik-test || true
        docker rm traefik-test || true
        docker network rm traefik-test || true

  # =============================================================================
  # VERIFICAÃ‡Ã•ES DE SEGURANÃ‡A
  # =============================================================================
  security-checks:
    name: ğŸ”’ VerificaÃ§Ãµes de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: validate-configs
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Verificar secrets expostos
      run: |
        # Verificar se nÃ£o hÃ¡ secrets hardcoded
        if grep -r -i "password\|secret\|key\|token" --include="*.yml" --include="*.yaml" .; then
          echo "âš ï¸ PossÃ­veis secrets encontrados nos arquivos de configuraÃ§Ã£o!"
          echo "Verifique se nÃ£o hÃ¡ credenciais hardcoded."
          # NÃ£o falhar o build, apenas alertar
        fi
        
    - name: ğŸ›¡ï¸ Verificar configuraÃ§Ãµes TLS
      run: |
        # Verificar se TLS estÃ¡ configurado corretamente
        if ! grep -q "certResolver: letsencrypt" dynamic/services.yml; then
          echo "âŒ ConfiguraÃ§Ã£o TLS nÃ£o encontrada!"
          exit 1
        fi
        
        if ! grep -q "minVersion: \"VersionTLS12\"" dynamic/services.yml; then
          echo "âš ï¸ VersÃ£o mÃ­nima do TLS nÃ£o configurada!"
        fi
        
    - name: ğŸ” Verificar middlewares de seguranÃ§a
      run: |
        # Verificar se middlewares de seguranÃ§a estÃ£o configurados
        if ! grep -q "security-headers" dynamic/middlewares.yml; then
          echo "âŒ Middleware de security headers nÃ£o encontrado!"
          exit 1
        fi
        
        if ! grep -q "rate-limit" dynamic/middlewares.yml; then
          echo "âš ï¸ Middleware de rate limiting nÃ£o encontrado!"
        fi

  # =============================================================================
  # ANÃLISE DE QUALIDADE
  # =============================================================================
  quality-analysis:
    name: ğŸ“Š AnÃ¡lise de Qualidade
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“ˆ AnÃ¡lise de complexidade
      run: |
        echo "ğŸ“Š EstatÃ­sticas do projeto:"
        echo "- Arquivos YAML: $(find . -name '*.yml' -o -name '*.yaml' | wc -l)"
        echo "- Routers configurados: $(grep -c 'rule:' dynamic/services.yml || echo 0)"
        echo "- Services configurados: $(grep -c 'loadBalancer:' dynamic/services.yml || echo 0)"
        echo "- Middlewares configurados: $(grep -c '^  [a-zA-Z].*:$' dynamic/middlewares.yml || echo 0)"
        
    - name: ğŸ“ Verificar documentaÃ§Ã£o
      run: |
        if [ ! -f README.md ]; then
          echo "âš ï¸ README.md nÃ£o encontrado!"
        fi
        
        if [ ! -f .env.example ]; then
          echo "âš ï¸ .env.example nÃ£o encontrado!"
        fi

  # =============================================================================
  # RELATÃ“RIO FINAL
  # =============================================================================
  report:
    name: ğŸ“‹ RelatÃ³rio Final
    runs-on: ubuntu-latest
    needs: [validate-configs, connectivity-tests, security-checks, quality-analysis]
    if: always()
    
    steps:
    - name: ğŸ“Š Status do Pipeline
      run: |
        echo "ğŸ¯ Pipeline CI executado com sucesso!"
        echo "âœ… ConfiguraÃ§Ãµes validadas"
        echo "âœ… Testes de conectividade executados"
        echo "âœ… VerificaÃ§Ãµes de seguranÃ§a realizadas"
        echo "âœ… AnÃ¡lise de qualidade concluÃ­da"
        
        if [ "${{ needs.validate-configs.result }}" != "success" ]; then
          echo "âŒ Falha na validaÃ§Ã£o de configuraÃ§Ãµes"
        fi
        
        if [ "${{ needs.connectivity-tests.result }}" != "success" ]; then
          echo "âŒ Falha nos testes de conectividade"
        fi
        
        if [ "${{ needs.security-checks.result }}" != "success" ]; then
          echo "âŒ Falha nas verificaÃ§Ãµes de seguranÃ§a"
        fi