name: ğŸš€ Traefik Infrastructure - CI/CD Pipeline (Self-hosted Runners)

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Destino do deploy'
        required: false
        default: 'production'
        type: choice
        options: [staging, production]
      force_deploy:
        description: 'ForÃ§ar deploy mesmo se validaÃ§Ã£o falhar'
        required: false
        default: false
        type: boolean
      skip_security:
        description: 'Pular verificaÃ§Ãµes de seguranÃ§a'
        required: false
        default: false
        type: boolean

env:
  SERVICE_NAME: traefik-infrastructure
  TZ: America/Sao_Paulo
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  validate-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    name: âœ… Validate Infrastructure Environment
    outputs:
      environment-valid: ${{ steps.env-check.outputs.valid }}
      runner-ready: ${{ steps.runner-check.outputs.ready }}
    steps:
      - uses: actions/checkout@v4
      - name: "Guard: Verificar configuraÃ§Ãµes Traefik obrigatÃ³rias"
        timeout-minutes: 10
        run: |
          set -euo pipefail
          echo "ğŸ” Verificando configuraÃ§Ãµes obrigatÃ³rias do Traefik..."
          
          # Verificar se arquivos de configuraÃ§Ã£o existem
          REQUIRED_FILES=(
            "traefik/traefik.yml"
            "traefik/dynamic/middlewares.yml"
            "traefik/dynamic/security-headers.yml"
            "traefik/dynamic/tls.yml"
            "docker-compose.yml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Arquivo obrigatÃ³rio nÃ£o encontrado: $file" >&2
              exit 1
            fi
            echo "âœ… $file encontrado"
          done
          
          # Verificar configuraÃ§Ãµes de seguranÃ§a obrigatÃ³rias
          if ! grep -q "websecure" traefik/traefik.yml; then
            echo "âŒ HTTPS (websecure) nÃ£o configurado" >&2
            exit 1
          fi
          
          if ! grep -q "letsencrypt" traefik/traefik.yml; then
            echo "âŒ Let's Encrypt nÃ£o configurado" >&2
            exit 1
          fi
          
          echo "âœ… ConfiguraÃ§Ãµes obrigatÃ³rias validadas"
      - name: "Guard: Verificar configuraÃ§Ãµes"
        id: env-check
        timeout-minutes: 10
        run: |
          echo "ğŸ” Verificando configuraÃ§Ãµes..."
          
          # Este job agora roda no GitHub runner, apenas verifica configuraÃ§Ãµes
          echo "âœ… ConfiguraÃ§Ãµes validadas no GitHub runner"
          echo "valid=true" >> $GITHUB_OUTPUT
      - name: ğŸƒ Verificar status do runner
        id: runner-check
        timeout-minutes: 2
        run: |
          echo "ğŸƒ Verificando status do runner..."
          echo "Runner: ${{ runner.name }}"
          echo "OS: ${{ runner.os }}"
          echo "Arch: ${{ runner.arch }}"
          echo "ready=true" >> $GITHUB_OUTPUT

  detect-changes:
    name: ğŸ” Detectar MudanÃ§as
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate-environment
    if: needs.validate-environment.outputs.environment-valid == 'true'
    outputs:
      config-changed: ${{ steps.changes.outputs.config }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
      environment: ${{ steps.deploy-check.outputs.environment }}
      run-security: ${{ steps.security-check.outputs.run-security }}
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        timeout-minutes: 5
        with:
          fetch-depth: 0
      - name: ğŸ” Detectar mudanÃ§as em arquivos
        uses: dorny/paths-filter@v3
        id: changes
        timeout-minutes: 5
        with:
          filters: |
            config:
              - 'traefik/**'
              - 'docker-compose.yml'
              - '.env.example'
      - name: âœ… Verificar necessidade de deploy
        id: deploy-check
        timeout-minutes: 2
        run: |
          SHOULD_DEPLOY="false"
          ENVIRONMENT="staging"
          
          # Deploy forÃ§ado via workflow_dispatch
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            SHOULD_DEPLOY="true"
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            echo "ğŸš€ Deploy forÃ§ado pelo usuÃ¡rio"
          # Deploy automÃ¡tico em tags para produÃ§Ã£o
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            SHOULD_DEPLOY="true"
            ENVIRONMENT="production"
            echo "ğŸ·ï¸ Deploy automÃ¡tico via tag"
          # Deploy automÃ¡tico em push para main (padrÃ£o)
          elif [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            SHOULD_DEPLOY="true"
            ENVIRONMENT="production"
            echo "ğŸ“¤ Deploy automÃ¡tico em push para main"
          fi
          
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
      - name: ğŸ”’ Verificar necessidade de security scan
        id: security-check
        timeout-minutes: 2
        run: |
          RUN_SECURITY="false"
          
          # Executar em push/PR se nÃ£o foi pulado
          if [ "${{ github.event.inputs.skip_security }}" != "true" ]; then
            RUN_SECURITY="true"
          fi
          
          echo "run-security=$RUN_SECURITY" >> $GITHUB_OUTPUT

  validate:
    name: âœ… ValidaÃ§Ã£o e Testes
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [validate-environment, detect-changes]
    if: needs.validate-environment.outputs.environment-valid == 'true' && (github.event_name == 'push' || github.event_name == 'pull_request' || needs.detect-changes.outputs.config-changed == 'true')
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        timeout-minutes: 5
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        timeout-minutes: 5
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        timeout-minutes: 5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '.github/requirements.txt'
      - name: ğŸ“¦ Instalar dependÃªncias Python
        timeout-minutes: 5
        run: |
          pip install -r .github/requirements.txt
      - name: ğŸ“‹ Validar sintaxe YAML
        timeout-minutes: 5
        run: |
          find . -name "*.yml" -o -name "*.yaml" | xargs yamllint -d relaxed || true
          echo "âœ… ValidaÃ§Ã£o YAML concluÃ­da (warnings ignorados)"
      - name: âš™ï¸ Validar configuraÃ§Ãµes Traefik
        timeout-minutes: 10
        run: |
          echo "ğŸ”§ Validando sintaxe dos arquivos de configuraÃ§Ã£o Traefik..."
          
          # ValidaÃ§Ã£o rÃ¡pida de sintaxe YAML
          for file in traefik/traefik.yml traefik/dynamic/middlewares.yml traefik/dynamic/security-headers.yml traefik/dynamic/tls.yml; do
            if [ -f "$file" ]; then
              if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "âœ… $file: Sintaxe YAML vÃ¡lida"
              else
                echo "âŒ $file: Erro de sintaxe YAML"
                exit 1
              fi
            else
              echo "âš ï¸ $file: Arquivo nÃ£o encontrado"
            fi
          done
          
          echo "âœ… ValidaÃ§Ã£o de configuraÃ§Ã£o Traefik concluÃ­da"
      - name: ğŸ³ Testar docker-compose
        timeout-minutes: 10
        run: |
          echo "ğŸ”§ Validando sintaxe do docker-compose.yml..."
          if [ -f "docker-compose.yml" ]; then
            # Instalar docker-compose para validaÃ§Ã£o
            sudo apt-get update && sudo apt-get install -y docker-compose
            docker-compose config || echo "âš ï¸ Aviso: ValidaÃ§Ã£o pode falhar sem variÃ¡veis de ambiente"
          else
            echo "âŒ docker-compose.yml nÃ£o encontrado"
            exit 1
          fi

  security:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate-environment, detect-changes]
    if: needs.validate-environment.outputs.environment-valid == 'true' && needs.detect-changes.outputs.run-security == 'true' && success()
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        timeout-minutes: 5
        with:
          fetch-depth: 0
      - name: ğŸ” Scan de secrets com gitleaks
        uses: gitleaks/gitleaks-action@v2
        timeout-minutes: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: ğŸ›¡ï¸ Verificar configuraÃ§Ãµes de seguranÃ§a
        timeout-minutes: 5
        run: |
          echo "ğŸ”’ Verificando configuraÃ§Ãµes de seguranÃ§a..."
          SCORE=0
          TOTAL=6
          
          # HTTPS obrigatÃ³rio
          if grep -q "websecure" traefik/traefik.yml; then
            echo "âœ… HTTPS configurado"
            SCORE=$((SCORE + 1))
          else
            echo "âŒ HTTPS nÃ£o configurado"
          fi
          
          # Let's Encrypt
          if grep -q "letsencrypt" traefik/traefik.yml; then
            echo "âœ… Let's Encrypt configurado"
            SCORE=$((SCORE + 1))
          else
            echo "âŒ Let's Encrypt nÃ£o configurado"
          fi
          
          # Security headers
          if grep -q "security-headers" traefik/dynamic/security-headers.yml; then
            echo "âœ… Security headers configurados"
            SCORE=$((SCORE + 1))
          else
            echo "âŒ Security headers nÃ£o configurados"
          fi
          
          # Rate limiting
          if grep -q "rate-limit" traefik/dynamic/middlewares.yml; then
            echo "âœ… Rate limiting configurado"
            SCORE=$((SCORE + 1))
          else
            echo "âŒ Rate limiting nÃ£o configurado"
          fi
          
          # TLS versÃ£o mÃ­nima
          if grep -q "VersionTLS12" traefik/dynamic/tls.yml; then
            echo "âœ… TLS versÃ£o mÃ­nima configurada"
            SCORE=$((SCORE + 1))
          else
            echo "âŒ TLS versÃ£o mÃ­nima nÃ£o configurada"
          fi
          
          # Logs de acesso
          if grep -q "accessLog" traefik/traefik.yml; then
            echo "âœ… Logs de acesso habilitados"
            SCORE=$((SCORE + 1))
          else
            echo "âŒ Logs de acesso nÃ£o habilitados"
          fi
          
          echo ""
          echo "ğŸ“Š Score de SeguranÃ§a: $SCORE/$TOTAL ($(( SCORE * 100 / TOTAL ))%)"
          
          if [ $SCORE -lt 4 ]; then
            echo "âš ï¸ Score de seguranÃ§a baixo. Revisar configuraÃ§Ãµes."
            exit 1
          fi

  deploy-selfhosted:
    runs-on: [self-hosted, Linux, X64, conexao, conexao-de-sorte-traefik-infraestrutura]
    timeout-minutes: 60
    name: ğŸš€ Deploy Traefik Infrastructure (Self-hosted)
    needs: [validate-environment, detect-changes, validate, security]
    if: needs.validate-environment.outputs.environment-valid == 'true' && needs.detect-changes.outputs.should-deploy == 'true' && success()
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: false
      
      - name: ğŸ§¹ Resolver conflitos de permissÃ£o
        timeout-minutes: 5
        run: |
          echo "ğŸ§¹ Resolvendo possÃ­veis conflitos de permissÃ£o..."
          # Ajustar permissÃµes de arquivos problemÃ¡ticos conhecidos
          if [ -f "./traefik/dynamic/middlewares.yml" ]; then
            chmod 644 ./traefik/dynamic/middlewares.yml || true
            echo "âœ… PermissÃµes ajustadas para middlewares.yml"
          fi
          # Ajustar permissÃµes de todo o diretÃ³rio traefik
          if [ -d "./traefik" ]; then
            find ./traefik -type f -exec chmod 644 {} \; 2>/dev/null || true
            find ./traefik -type d -exec chmod 755 {} \; 2>/dev/null || true
            echo "âœ… PermissÃµes ajustadas para diretÃ³rio traefik"
          fi
          echo "âœ… Conflitos de permissÃ£o resolvidos"
      
      - name: Verificar ambiente do self-hosted runner
        timeout-minutes: 10
        run: |
          echo "ğŸ” Verificando ambiente do self-hosted runner..."
          echo "ğŸ–¥ï¸ Runner: $(hostname)"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
          echo "ğŸ“ DiretÃ³rio: $(pwd)"
          echo "ğŸ’¾ EspaÃ§o disponÃ­vel:"
          df -h
          echo "ğŸ³ Docker version:"
          docker --version
          echo "ğŸ™ Docker Compose version:"
          docker compose version || docker-compose --version
      - name: Azure Login (OIDC) no self-hosted runner
        timeout-minutes: 10
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Fetch Azure Key Vault secrets
        id: kv
        timeout-minutes: 10
        shell: bash
        run: |
          set -euo pipefail
          VAULT_ENDPOINT="${{ secrets.AZURE_KEYVAULT_ENDPOINT }}"
          if [[ "$VAULT_ENDPOINT" =~ https://([^.]+)\.vault\.azure\.net ]]; then
            VAULT="${BASH_REMATCH[1]}"
          else
            echo "ERROR: Invalid AZURE_KEYVAULT_ENDPOINT format: $VAULT_ENDPOINT" >&2
            exit 1
          fi
          
          echo "Loading secrets from Azure Key Vault: $VAULT" >&2
          get() { 
            echo "Fetching secret: $1" >&2
            SECRET_VALUE=$(az keyvault secret show --vault-name "$VAULT" --name "$1" --query value -o tsv 2>/dev/null)
            if [ $? -ne 0 ] || [ -z "$SECRET_VALUE" ]; then
              echo "ERROR: Secret $1 not found in Azure Key Vault $VAULT" >&2
              exit 1
            fi
            echo "$SECRET_VALUE"
          }
          
          # Traefik infrastructure secrets
          echo "TRAEFIK_DASHBOARD_USER=$(get conexao-de-sorte-traefik-dashboard-user)" >> $GITHUB_ENV
          echo "TRAEFIK_DASHBOARD_PASSWORD=$(get conexao-de-sorte-traefik-dashboard-password)" >> $GITHUB_ENV
          echo "LETSENCRYPT_EMAIL=$(get conexao-de-sorte-letsencrypt-email)" >> $GITHUB_ENV
          echo "CLOUDFLARE_API_TOKEN=$(get conexao-de-sorte-cloudflare-api-token)" >> $GITHUB_ENV
          echo "DOMAIN_NAME=$(get conexao-de-sorte-domain-name)" >> $GITHUB_ENV
          
          echo "âœ… Azure Key Vault secrets loaded successfully" >&2
      - name: ğŸ§¹ Limpar containers antigos do Traefik
        timeout-minutes: 10
        run: |
          set -euo pipefail
          echo "ğŸ§¹ Limpando containers antigos do Traefik..."
          
          CONTAINER_NAME="traefik"
          
          # Parar e remover container Traefik existente
          if docker ps -a --format '{{.Names}}' | grep -q "^$CONTAINER_NAME$"; then
            echo "ğŸ›‘ Parando container: $CONTAINER_NAME"
            docker stop "$CONTAINER_NAME" || true
            echo "ğŸ—‘ï¸ Removendo container: $CONTAINER_NAME"
            docker rm "$CONTAINER_NAME" || true
          else
            echo "âœ… Nenhum container $CONTAINER_NAME encontrado"
          fi
          
          # Limpar imagens antigas do Traefik (manter apenas as 2 mais recentes)
          docker images --format "{{.Repository}}:{{.Tag}}" | grep "^traefik:" | head -n -2 | xargs -r docker rmi || true
          echo "âœ… Limpeza de containers concluÃ­da"
      - name: ğŸŒ Criar rede Docker
        timeout-minutes: 10
        run: |
          echo "ğŸŒ Criando rede conexao-network..."
          docker network create conexao-network 2>/dev/null || echo "âœ… Rede conexao-network jÃ¡ existe"
      - name: ğŸ“ Preparar configuraÃ§Ãµes do Traefik
        timeout-minutes: 10
        run: |
          echo "ğŸ“ Preparando configuraÃ§Ãµes do Traefik..."
          
          # Criar diretÃ³rio de certificados se nÃ£o existir
          mkdir -p ./traefik/certs
          
          # Verificar estrutura de diretÃ³rios
          echo "ğŸ“ Estrutura de diretÃ³rios Traefik:"
          find ./traefik -type f -name "*.yml" | head -10 || echo "Nenhum arquivo YAML encontrado"
          
          # Verificar arquivos crÃ­ticos
          if [ -f "./traefik/traefik.yml" ]; then
            echo "âœ… traefik.yml encontrado"
          else
            echo "âŒ traefik.yml nÃ£o encontrado"
            exit 1
          fi
          
          if [ -f "./traefik/dynamic/middlewares.yml" ]; then
            echo "âœ… middlewares.yml encontrado"
            # Verificar se o arquivo nÃ£o estÃ¡ corrompido
            head -5 ./traefik/dynamic/middlewares.yml || echo "âš ï¸ Problema ao ler middlewares.yml"
          else
            echo "âŒ middlewares.yml nÃ£o encontrado"
            exit 1
          fi
          
          echo "âœ… ConfiguraÃ§Ãµes preparadas"
      - name: ğŸš€ Deploy Traefik via Docker Compose
        timeout-minutes: 30
        run: |
          set -euo pipefail
          export TZ=America/Sao_Paulo
          
          echo "ğŸš€ Iniciando deploy do Traefik..."
          
          # Exportar variÃ¡veis de ambiente para o Docker Compose
          export TRAEFIK_DASHBOARD_USER="${{ env.TRAEFIK_DASHBOARD_USER }}"
          export TRAEFIK_DASHBOARD_PASSWORD="${{ env.TRAEFIK_DASHBOARD_PASSWORD }}"
          export LETSENCRYPT_EMAIL="${{ env.LETSENCRYPT_EMAIL }}"
          export CLOUDFLARE_API_TOKEN="${{ env.CLOUDFLARE_API_TOKEN }}"
          export DOMAIN_NAME="${{ env.DOMAIN_NAME }}"
          
          # Deploy usando Docker Compose
          docker compose up -d --remove-orphans
          
          echo "âœ… Traefik deployado com sucesso"
      - name: â³ Aguardar Traefik ficar pronto
        timeout-minutes: 10
        run: |
          echo "â³ Aguardando Traefik ficar pronto..."
          TIMEOUT=180
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if docker exec traefik wget -q --spider http://localhost:8080/ping 2>/dev/null; then
              echo "âœ… Traefik estÃ¡ pronto e saudÃ¡vel!"
              break
            fi
            echo "â³ Aguardando Traefik ficar pronto... ($ELAPSED/$TIMEOUT segundos)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âŒ Traefik falhou em ficar pronto em $TIMEOUT segundos"
            echo "ğŸ“‹ Logs do container:"
            docker logs traefik --tail 50
            exit 1
          fi
          
          echo "ğŸ“Š Status final do container:"
          docker ps --filter name=traefik --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
          
          echo "ğŸ‰ Deploy do Traefik concluÃ­do com sucesso - ServiÃ§o estÃ¡ saudÃ¡vel!"
      - name: ğŸ‰ NotificaÃ§Ã£o de sucesso local
        timeout-minutes: 10
        run: |
          echo "ğŸ‰ Deploy do Traefik realizado com sucesso via OIDC!"
          echo "ğŸ” MÃ©todo: Azure OIDC + Key Vault (sem SSH)"
          echo "ğŸƒ Runner: Self-hosted $(hostname)"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ“… Data: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸŒ Traefik Dashboard: https://traefik.${{ env.DOMAIN_NAME }}"
          echo "âœ… Deploy seguro concluÃ­do sem dependÃªncias SSH"

  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: ğŸ“¢ Notification
    if: always()
    needs: [validate, security, deploy-selfhosted]
    steps:
      - name: ğŸ“¢ Send Slack notification
        if: always()
        timeout-minutes: 10
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          DEPLOY_RESULT="${{ needs.deploy-selfhosted.result }}"
          if [ "$DEPLOY_RESULT" = "success" ]; then
            STATUS="ğŸš€ SUCCESS (Self-hosted)"
            COLOR="good"
          elif [ "$DEPLOY_RESULT" = "skipped" ]; then
            STATUS="â­ï¸ SKIPPED"
            COLOR="warning"
          else
            STATUS="âŒ FAILED"
            COLOR="danger"
          fi
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{'text':'$STATUS: Traefik Infrastructure Self-hosted Deploy','attachments':[{'color':'$COLOR','fields':[{'title':'Branch','value':'${{ github.ref_name }}','short':true},{'title':'Commit','value':'${{ github.sha }}','short':true},{'title':'Deploy Method','value':'Self-hosted Runner (No SSH)','short':true}]}]}" \
            $SLACK_WEBHOOK_URL || echo "Slack notification failed or webhook not configured"