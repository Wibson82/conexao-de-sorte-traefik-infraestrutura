name: "ğŸš€ Deploy Traefik Infrastructure"

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if validation fails'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      restart_services:
        description: 'Restart all services after deploy'
        required: false
        default: false
        type: boolean

  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  DEPLOY_TIMEOUT: 300
  HEALTH_CHECK_RETRIES: 10
  TZ: America/Sao_Paulo

jobs:
  # =============================================================================
  # PRÃ‰-VALIDAÃ‡Ã•ES
  # =============================================================================
  pre-deploy-checks:
    name: ğŸ” VerificaÃ§Ãµes PrÃ©-Deploy
    runs-on: ubuntu-latest
    
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      environment: ${{ steps.check.outputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” Verificar mudanÃ§as
      id: check
      run: |
        # Determinar ambiente
        if [ "${{ github.event.inputs.environment }}" != "" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          ENVIRONMENT="production"
        else
          ENVIRONMENT="staging"
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        
        # Verificar se deve fazer deploy
        SHOULD_DEPLOY="true"
        
        if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
          echo "ğŸš€ Deploy forÃ§ado pelo usuÃ¡rio"
          SHOULD_DEPLOY="true"
        elif [ "$ENVIRONMENT" == "production" ] && [ "${{ github.ref_type }}" != "tag" ]; then
          echo "âš ï¸ Deploy para produÃ§Ã£o apenas com tags"
          SHOULD_DEPLOY="false"
        fi
        
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        
    - name: ğŸ“‹ Resumo das verificaÃ§Ãµes
      run: |
        echo "ğŸ¯ Ambiente: ${{ steps.check.outputs.environment }}"
        echo "ğŸš€ Deve fazer deploy: ${{ steps.check.outputs.should_deploy }}"
        echo "ğŸ“ Ref: ${{ github.ref }}"
        echo "ğŸ·ï¸ Ref type: ${{ github.ref_type }}"

  # =============================================================================
  # BACKUP DE CONFIGURAÃ‡Ã•ES
  # =============================================================================
  backup-configs:
    name: ğŸ’¾ Backup ConfiguraÃ§Ãµes
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ’¾ Criar backup das configuraÃ§Ãµes
      run: |
        # Criar timestamp para backup
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        BACKUP_DIR="backup_configs_${TIMESTAMP}"
        
        # Criar estrutura de backup
        mkdir -p "$BACKUP_DIR"
        
        # Copiar configuraÃ§Ãµes atuais
        cp -r config/ "$BACKUP_DIR/"
        cp -r dynamic/ "$BACKUP_DIR/"
        cp docker-compose.yml "$BACKUP_DIR/"
        cp .env.example "$BACKUP_DIR/"
        
        # Criar arquivo de metadados
        cat > "$BACKUP_DIR/metadata.json" << EOF
        {
          "timestamp": "$TIMESTAMP",
          "commit": "${{ github.sha }}",
          "ref": "${{ github.ref }}",
          "environment": "${{ needs.pre-deploy-checks.outputs.environment }}",
          "actor": "${{ github.actor }}"
        }
        EOF
        
        # Comprimir backup
        tar -czf "backup_configs_${TIMESTAMP}.tar.gz" "$BACKUP_DIR"
        
        echo "ğŸ“¦ Backup criado: backup_configs_${TIMESTAMP}.tar.gz"
        
    - name: ğŸ“¤ Upload backup como artefato
      uses: actions/upload-artifact@v4
      with:
        name: config-backup-${{ github.sha }}
        path: backup_configs_*.tar.gz
        retention-days: 30

  # =============================================================================
  # VALIDAÃ‡ÃƒO FINAL
  # =============================================================================
  final-validation:
    name: âœ… ValidaÃ§Ã£o Final
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, backup-configs]
    if: needs.pre-deploy-checks.outputs.should_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”§ ValidaÃ§Ã£o completa das configuraÃ§Ãµes
      run: |
        # Validar YAML
        pip install yamllint
        find . -name "*.yml" -o -name "*.yaml" | xargs yamllint -d relaxed
        
        # Validar Traefik
        docker run --rm \
          -v "$PWD/config:/etc/traefik:ro" \
          -v "$PWD/dynamic:/etc/traefik/dynamic:ro" \
          traefik:v3.0 \
          traefik --configfile=/etc/traefik/traefik.yml --dry-run
          
        # Validar docker-compose
        docker-compose config
        
    - name: ğŸ”’ VerificaÃ§Ã£o de seguranÃ§a final
      run: |
        # Verificar TLS
        if ! grep -q "certResolver: letsencrypt" dynamic/services.yml; then
          echo "âŒ ConfiguraÃ§Ã£o TLS obrigatÃ³ria para produÃ§Ã£o!"
          exit 1
        fi
        
        # Verificar HTTPS redirect
        if ! grep -q "websecure" dynamic/services.yml; then
          echo "âŒ HTTPS obrigatÃ³rio para produÃ§Ã£o!"
          exit 1
        fi
        
        # Verificar rate limiting
        if [ "${{ needs.pre-deploy-checks.outputs.environment }}" == "production" ]; then
          if ! grep -q "rate-limit" dynamic/middlewares.yml; then
            echo "âš ï¸ Rate limiting recomendado para produÃ§Ã£o"
          fi
        fi

  # =============================================================================
  # DEPLOY
  # =============================================================================
  deploy:
    name: ğŸš€ Deploy ${{ needs.pre-deploy-checks.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, backup-configs, final-validation]
    if: needs.pre-deploy-checks.outputs.should_deploy == 'true'
    environment: ${{ needs.pre-deploy-checks.outputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar ambiente
      run: |
        # Criar .env baseado no ambiente
        if [ "${{ needs.pre-deploy-checks.outputs.environment }}" == "production" ]; then
          echo "ENVIRONMENT=production" >> .env
          echo "LOG_LEVEL=INFO" >> .env
          echo "TRAEFIK_LOG_LEVEL=INFO" >> .env
        else
          echo "ENVIRONMENT=staging" >> .env
          echo "LOG_LEVEL=DEBUG" >> .env
          echo "TRAEFIK_LOG_LEVEL=DEBUG" >> .env
        fi
        
        # Adicionar timestamp
        echo "DEPLOY_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .env
        echo "DEPLOY_COMMIT=${{ github.sha }}" >> .env
        
    - name: ğŸ”‘ Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: ğŸ“¦ Preparar arquivos para deploy
      run: |
        # Criar pacote de deploy
        tar -czf deploy-package.tar.gz \
          config/ \
          dynamic/ \
          docker-compose.yml \
          .env
        
    - name: ğŸ“¤ Upload arquivos para servidor
      run: |
        scp deploy-package.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:~/traefik-deploy/
        
    - name: ğŸ³ Deploy via SSH
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/traefik-deploy
          
          echo "ğŸš€ Iniciando deploy para ${{ needs.pre-deploy-checks.outputs.environment }}"
          
          # Extrair arquivos
          tar -xzf deploy-package.tar.gz
          
          # Backup atual
          if [ -d "current" ]; then
            mv current backup-$(date +%Y%m%d_%H%M%S)
          fi
          
          # Criar nova estrutura
          mkdir -p current
          mv config dynamic docker-compose.yml .env current/
          
          cd current
          
          echo "ğŸ“¦ Preparando containers..."
          docker-compose config
          
          echo "ğŸ”„ Atualizando configuraÃ§Ãµes..."
          docker-compose pull
          docker-compose up -d --force-recreate traefik
          
          # Reiniciar serviÃ§os se solicitado
          if [ "${{ github.event.inputs.restart_services }}" == "true" ]; then
            echo "ğŸ”„ Reiniciando todos os serviÃ§os..."
            docker-compose restart
          fi
          
          echo "âœ… Deploy concluÃ­do!"
        EOF
        
    - name: ğŸ” VerificaÃ§Ã£o pÃ³s-deploy
      run: |
        echo "ğŸ” Verificando saÃºde dos serviÃ§os..."
        
        # Aguardar serviÃ§os iniciarem
        sleep 30
        
        # Verificar endpoints via SSH
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/traefik-deploy/current
          
          # Verificar containers
          docker-compose ps
          
          # Verificar logs
          docker-compose logs --tail=50 traefik
          
          # Verificar endpoints (substituir por URLs reais)
          # curl -f https://conexaodesorte.com.br/health || exit 1
          # curl -f https://traefik.conexaodesorte.com.br/api/rawdata || exit 1
        EOF
        
        echo "âœ… VerificaÃ§Ãµes pÃ³s-deploy concluÃ­das!"

  notify-success:
    name: "âœ… Notificar Sucesso"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, backup-configs, deploy]
    if: success()
    steps:
      - name: "ğŸ‰ Deploy realizado com sucesso"
        run: |
          echo "ğŸ‰ DEPLOY REALIZADO COM SUCESSO!"
          echo "   - RepositÃ³rio: ${{ github.repository }}"
          echo "   - Branch: ${{ github.ref_name }}"
          echo "   - Commit: ${{ github.sha }}"
          echo "   - Ambiente: ${{ needs.pre-deploy-checks.outputs.environment }}"
          echo "   - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   - Workflow: ${{ github.workflow }}"
          echo "   - Run ID: ${{ github.run_id }}"

  notify-failure:
    name: "ğŸš¨ Notificar Falha"
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, backup-configs, deploy]
    if: failure()
    steps:
      - name: "ğŸ“¢ NotificaÃ§Ã£o de falha"
        run: |
          echo "âŒ FALHA NO DEPLOY"
          echo "   - RepositÃ³rio: ${{ github.repository }}"
          echo "   - Branch: ${{ github.ref_name }}"
          echo "   - Commit: ${{ github.sha }}"
          echo "   - Ambiente: ${{ needs.pre-deploy-checks.outputs.environment }}"
          echo "   - Workflow: ${{ github.workflow }}"
          echo "   - Run ID: ${{ github.run_id }}"
          echo "   - URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ” Verifique os logs acima para identificar o problema."
          echo "ğŸ”„ Para fazer rollback, execute o workflow de rollback manual."

  # =============================================================================
  # NOTIFICAÃ‡Ã•ES
  # =============================================================================
  notify:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy]
    if: always() && needs.pre-deploy-checks.outputs.should_deploy == 'true'
    
    steps:
    - name: ğŸ“Š Status do Deploy
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸ¯ Ambiente: ${{ needs.pre-deploy-checks.outputs.environment }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        else
          echo "âŒ Falha no deploy!"
          echo "ğŸ¯ Ambiente: ${{ needs.pre-deploy-checks.outputs.environment }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ• Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        fi
        
    # Adicionar integraÃ§Ãµes de notificaÃ§Ã£o aqui:
    # - Slack
    # - Discord
    # - Email
    # - Teams
    # etc.

  # =============================================================================
  # ROLLBACK (EM CASO DE FALHA)
  # =============================================================================
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy]
    if: failure() && needs.pre-deploy-checks.outputs.should_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Download backup
      uses: actions/download-artifact@v4
      with:
        name: config-backup-${{ github.sha }}
        
    - name: ğŸ”„ Executar rollback
      run: |
        echo "ğŸš¨ Iniciando procedimento de rollback..."
        
        # Extrair backup
        tar -xzf backup_configs_*.tar.gz
        
        # Restaurar configuraÃ§Ãµes (implementar lÃ³gica real)
        echo "ğŸ“¦ Restaurando configuraÃ§Ãµes anteriores..."
        
        # Reiniciar serviÃ§os
        echo "ğŸ”„ Reiniciando serviÃ§os..."
        
        echo "âœ… Rollback concluÃ­do!"
        
    - name: ğŸ“¢ Notificar rollback
      run: |
        echo "ğŸš¨ ROLLBACK EXECUTADO!"
        echo "ğŸ¯ Ambiente: ${{ needs.pre-deploy-checks.outputs.environment }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        echo "ğŸ• Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"