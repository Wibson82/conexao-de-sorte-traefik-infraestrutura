# =============================================================================
# üåê TRAEFIK MICROSERVICES ROUTING CONFIGURATION - PRODU√á√ÉO
# =============================================================================
# ARQUITETURA: Internet ‚Üí Traefik (SSL + Load Balance) ‚Üí Gateway ‚Üí Microservi√ßos
# RESPONSABILIDADE TRAEFIK: SSL termination + roteamento para Gateway √∫nico
# VERS√ÉO: v2.0 - Integra√ß√£o Gateway-first approach
# =============================================================================

http:
  routers:
    # ==========================================================================
    # üö™ GATEWAY PRINCIPAL - PONTO √öNICO DE ENTRADA
    # ==========================================================================
    # TODO O TR√ÅFEGO DA API VAI PARA O GATEWAY
    api-gateway:
      rule: "Host(`api.conexaodesorte.com.br`)"
      entrypoints:
        - websecure
      middlewares:
        - security-headers-api
        - cors-basic
        - rate-limit-gateway
      service: gateway-service
      tls:
        certresolver: letsencrypt
      priority: 1000

    # Redirect HTTP to HTTPS para API
    api-gateway-redirect:
      rule: "Host(`api.conexaodesorte.com.br`)"
      entrypoints:
        - web
      middlewares:
        - https-redirect
      service: gateway-service
      priority: 900

    # ==========================================================================
    # üåê FRONTEND APPLICATION
    # ==========================================================================
    frontend-main:
      rule: "Host(`conexaodesorte.com.br`) || Host(`www.conexaodesorte.com.br`)"
      entrypoints:
        - websecure
      middlewares:
        - security-headers
        - gzip-compress
        - redirect-to-www
      service: frontend-service
      tls:
        certresolver: letsencrypt

    # Frontend HTTP -> HTTPS redirect
    frontend-redirect:
      rule: "Host(`conexaodesorte.com.br`) || Host(`www.conexaodesorte.com.br`)"
      entrypoints:
        - web
      middlewares:
        - redirect-to-https
      service: frontend-service

    # ==========================================================================
    # üõ†Ô∏è ADMIN & MANAGEMENT
    # ==========================================================================
    traefik-dashboard:
      rule: "Host(`traefik.conexaodesorte.com.br`)"
      entrypoints:
        - websecure
      middlewares:
        - admin-auth
        - security-headers
        - ip-allow-local
      service: api@internal
      tls:
        certresolver: letsencrypt

  # ============================================================================
  # üîß SERVICES CONFIGURATION
  # ============================================================================
  services:
    # ==========================================================================
    # üö™ GATEWAY SERVICE - PONTO √öNICO DE ENTRADA PARA APIS
    # ==========================================================================
    gateway-service:
      loadBalancer:
        healthCheck:
          path: "/actuator/health"
          interval: "30s"
          timeout: "10s"
          scheme: "http"
        # SER√Å AUTO-DESCOBERTO pelo Docker provider quando Gateway estiver rodando
        # Configura√ß√£o manual: servers: - url: "http://conexao-gateway:8086"

    # ==========================================================================
    # üåê FRONTEND SERVICE
    # ==========================================================================
    frontend-service:
      loadBalancer:
        healthCheck:
          path: "/health.json"
          interval: "30s"
          timeout: "10s"
          scheme: "http"
        # SER√Å AUTO-DESCOBERTO pelo Docker provider quando Frontend estiver rodando
        # Configura√ß√£o manual: servers: - url: "http://conexao-frontend:3000"

# ==============================================================================
# üìù CONFIGURATION NOTES - GATEWAY-FIRST ARCHITECTURE
# ==============================================================================
#
# üèóÔ∏è ARQUITETURA ATUALIZADA:
# Internet ‚Üí Traefik (SSL + Load Balance) ‚Üí Gateway ‚Üí Microservi√ßos
#
# üîß RESPONSABILIDADES TRAEFIK:
# 1. SSL/TLS Termination (Let's Encrypt)
# 2. Load Balancing b√°sico
# 3. Roteamento por dom√≠nio APENAS
# 4. Headers de seguran√ßa b√°sicos
#
# üö™ RESPONSABILIDADES GATEWAY:
# 1. Roteamento inteligente por path (/rest/PROJECT/*)
# 2. Rate limiting avan√ßado por servi√ßo
# 3. Circuit breaker e retry logic
# 4. Autentica√ß√£o/Autoriza√ß√£o JWT
# 5. Observabilidade detalhada
# 6. Transforma√ß√£o de requests/responses
#
# üè∑Ô∏è REQUIRED CONTAINER LABELS GATEWAY:
# Gateway container deve ter:
#   - traefik.enable=true
#   - traefik.http.services.gateway-service.loadbalancer.server.port=8086
#   - traefik.docker.network=conexao-network-swarm
#
# üè∑Ô∏è REQUIRED CONTAINER LABELS FRONTEND:
# Frontend container deve ter:
#   - traefik.enable=true
#   - traefik.http.services.frontend-service.loadbalancer.server.port=3000
#   - traefik.docker.network=conexao-network-swarm
#
# üåê DOMAIN CONFIGURATION:
# - Frontend: conexaodesorte.com.br + www.conexaodesorte.com.br
# - API: api.conexaodesorte.com.br ‚Üí Gateway ‚Üí Microservi√ßos
# - Admin: traefik.conexaodesorte.com.br
#
# üîí SECURITY FEATURES:
# - HTTPS obrigat√≥rio com Let's Encrypt
# - Rate limiting b√°sico no Traefik
# - Rate limiting avan√ßado no Gateway
# - Security headers aplicados
#
# ‚ö° PERFORMANCE FEATURES:
# - Health checks para Gateway e Frontend
# - Compression habilitada
# - HTTP/3 support
# - Load balancing autom√°tico
#
# üîÑ MIDDLEWARES NECESS√ÅRIOS:
# Definir em middlewares.yml:
# - security-headers-api
# - cors-basic
# - rate-limit-gateway
# - https-redirect
# ==============================================================================