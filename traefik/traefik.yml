# =============================================================================
# üöÄ CONEX√ÉO DE SORTE - TRAEFIK v3.5.2 MODERNA E ESCAL√ÅVEL
# =============================================================================
# Configura√ß√£o principal otimizada para:
# - Seguran√ßa avan√ßada (OWASP compliance)
# - Escalabilidade para futuras APIs REST
# - Performance otimizada
# - Facilidade de manuten√ß√£o e expans√£o
# =============================================================================

---
global:
  checkNewVersion: false
  sendAnonymousUsage: false

# =============================================================================
# üìä API E DASHBOARD - SEGURO E MONITOR√ÅVEL
# =============================================================================
api:
  dashboard: true
  insecure: false
  debug: false
  # Habilitado para m√©tricas e health checks internos

# =============================================================================
# üåê ENTRY POINTS - HTTP/HTTPS/HTTP3 OTIMIZADOS
# =============================================================================
entryPoints:
  # HTTP Entry Point - Apenas para redirecionamentos e ACME challenge
  web:
    address: ":80"
    # Rate limiting no entry point para DDoS protection
    transport:
      respondingTimeouts:
        readTimeout: "10s"
        writeTimeout: "10s"
        idleTimeout: "120s"

  # HTTPS Entry Point - Produ√ß√£o com HTTP/3
  websecure:
    address: ":443"
    # HTTP/3 (QUIC) para performance moderna
    http3:
      advertisedPort: 443
    transport:
      respondingTimeouts:
        readTimeout: "30s"
        writeTimeout: "30s"
        idleTimeout: "300s"
    http:
      middlewares:
        - "rate-limit-global@file"
    # Configura√ß√£o avan√ßada de TLS
    tls:
      options: modern-tls@file

  # Dashboard interno - Apenas interno
  traefik-internal:
    address: ":8080"
    transport:
      respondingTimeouts:
        readTimeout: "5s"
        writeTimeout: "5s"
        idleTimeout: "60s"

# =============================================================================
# üì° PROVIDERS - DOCKER SWARM + ARQUIVOS DIN√ÇMICOS
# =============================================================================
providers:
  # Docker Swarm Provider - Detec√ß√£o autom√°tica
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    watch: true
    network: conexao-network-swarm
    swarmMode: true  # Expl√≠cito para Docker Swarm
    useBindPortIP: false
    # Polling interval otimizado
    pollInterval: "5s"
    # Constraints para filtrar servi√ßos
    constraints: "Label(`traefik.enable`, `true`)"

  # File Provider - Configura√ß√£o din√¢mica
  file:
    directory: "/etc/traefik/dynamic"
    watch: true
    # Intervalo de verifica√ß√£o otimizado
    pollInterval: "2s"

# =============================================================================
# üìù LOGGING - ESTRUTURADO E SEGURO
# =============================================================================
log:
  level: INFO
  format: json
  filePath: "/dev/stdout"  # Container-friendly logging

# Access logs desabilitados para evitar vazamento de dados
# Podem ser habilitados em desenvolvimento se necess√°rio
# accessLog:
#   format: json
#   bufferingSize: 0
#   filters:
#     statusCodes:
#       - "400-499"
#       - "500-599"

# =============================================================================
# üîê CERTIFICADOS SSL - LET'S ENCRYPT OTIMIZADO
# =============================================================================
certificatesResolvers:
  letsencrypt:
    acme:
      email: "facilitaservicos.tec@gmail.com"
      storage: /letsencrypt/acme.json
      # Usar HTTP challenge (mais est√°vel que DNS)
      httpChallenge:
        entryPoint: web
      # Rate limiting interno do ACME
      caServer: "https://acme-v02.api.letsencrypt.org/directory"

  # Resolver de staging para testes (comentado para produ√ß√£o)
  # letsencrypt-staging:
  #   acme:
  #     email: "facilitaservicos.tec@gmail.com"
  #     storage: /letsencrypt/acme-staging.json
  #     caServer: "https://acme-staging-v02.api.letsencrypt.org/directory"
  #     httpChallenge:
  #       entryPoint: web

# =============================================================================
# üìä M√âTRICAS E MONITORAMENTO - PROMETHEUS + HEALTH CHECKS
# =============================================================================
ping:
  entryPoint: traefik-internal

metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
    addRoutersLabels: true
    # Buckets otimizados para web applications
    buckets:
      - 0.005
      - 0.01
      - 0.025
      - 0.05
      - 0.1
      - 0.25
      - 0.5
      - 1.0
      - 2.5
      - 5.0
      - 10.0

# =============================================================================
# üöÄ TRANSPORT CONFIGURATIONS - DESABILITADO AT√â VALIDAR TRUSTSTORE DO CONTAINER
# =============================================================================
# serversTransport:
#   # SSL/TLS configuration para backend services
#   insecureSkipVerify: false  # Manter seguran√ßa
#   rootCAs:
#     - "/etc/ssl/certs/ca-certificates.crt"
#   # Timeouts otimizados para APIs REST
#   forwardingTimeouts:
#     dialTimeout: "10s"
#     responseHeaderTimeout: "30s"
#     expectContinueTimeout: "1s"
#     idleConnTimeout: "90s"
#   # Connection pooling para performance
#   maxIdleConnsPerHost: 10
#   disableHTTP2: false  # Manter HTTP/2 habilitado

# =============================================================================
# üîß CONFIGURA√á√ïES EXPERIMENTAIS - DESABILITADAS AT√â VALIDA√á√ÉO
# =============================================================================
# experimental:
#   http3: true

# =============================================================================
# üìà CLUSTER CONFIGURATION - PENDENTE DE CONSUL/ETCD
# =============================================================================
# cluster:
#   store: "consul"
#   prefix: "/traefik"

# Os blocos acima permanecem comentados at√© que os backends necess√°rios
# (Consul/etcd e valida√ß√£o de plugins) estejam provisionados em produ√ß√£o.
