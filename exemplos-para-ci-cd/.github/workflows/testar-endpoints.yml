name: ğŸ§ª Testar Endpoints

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de teste'
        required: true
        default: 'completo'
        type: choice
        options:
          - completo
          - rapido
          - diagnostico

jobs:
  testar-endpoints:
    name: ğŸ§ª Testar Endpoints via SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”‘ Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ§ª Executar testes de endpoints
        run: |
          echo "ğŸ§ª TESTE DE ENDPOINTS VIA SSH"
          echo "=============================="
          echo ""
          
          # ConfiguraÃ§Ãµes
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          DOMAIN="www.conexaodesorte.com.br"
          
          # FunÃ§Ã£o para executar comando SSH
          execute_ssh() {
            ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$1"
          }
          
          echo "ğŸ” 1. Verificando status dos containers..."
          execute_ssh "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
          echo ""
          
          echo "ğŸ§ª 2. Testando backend-teste (localhost:8081)..."
          TESTE_8081=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/rest/actuator/health || echo 'ERRO'")
          echo "Backend-teste (8081): $TESTE_8081"
          
          echo "ğŸš€ 3. Testando backend-prod (localhost:8080)..."
          TESTE_8080=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/rest/actuator/health || echo 'ERRO'")
          echo "Backend-prod (8080): $TESTE_8080"
          
          echo "ğŸŒ 4. Testando endpoint pÃºblico direto..."
          TESTE_PUBLICO=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/rest/v1/publico/resultados/hoje || echo 'ERRO'")
          echo "Endpoint pÃºblico: $TESTE_PUBLICO"
          
          echo "ğŸ¥ 5. Testando health check direto..."
          TESTE_HEALTH=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/rest/actuator/health || echo 'ERRO'")
          echo "Health check: $TESTE_HEALTH"
          
          echo "ğŸ§ª 6. Testando endpoint de teste direto..."
          TESTE_ENDPOINT_TESTE=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/rest/actuator/health || echo 'ERRO'")
          echo "Endpoint teste: $TESTE_ENDPOINT_TESTE"
          
          echo ""
          echo "ğŸ“‹ 7. Verificando logs backend-teste..."
          execute_ssh "docker logs --tail 10 backend-teste 2>&1 | grep -E '(ERROR|WARN|mapping|controller|endpoint)' || echo 'Nenhum log relevante'"
          
          echo ""
          echo "ğŸ“‹ 8. Verificando conectividade direta..."
          CONECTIVIDADE=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/rest/actuator/health || echo 'ERRO'")
          echo "Conectividade direta backend-teste: $([[ "$CONECTIVIDADE" == "200" ]] && echo "OK" || echo "FALHA")"
          
          echo ""
          echo "ğŸ“Š RESUMO DOS TESTES:"
          echo "   ğŸ§ª Backend-teste (8081): $([[ "$TESTE_8081" == "200" ]] && echo "âœ… OK" || echo "âŒ FALHA")"
          echo "   ğŸš€ Backend-prod (8080): $([[ "$TESTE_8080" == "200" ]] && echo "âœ… OK" || echo "âš ï¸ INATIVO")"
          echo "   ğŸŒ Endpoint pÃºblico: $([[ "$TESTE_PUBLICO" == "200" ]] && echo "âœ… OK" || echo "âŒ FALHA")"
          echo "   ğŸ¥ Health check: $([[ "$TESTE_HEALTH" == "200" ]] && echo "âœ… OK" || echo "âŒ FALHA")"
          echo "   ğŸ§ª Teste direto: $([[ "$TESTE_ENDPOINT_TESTE" == "200" ]] && echo "âœ… OK" || echo "âŒ FALHA")"
          echo "   ğŸ”— Conectividade interna: $([[ "$CONECTIVIDADE" != "FALHA" ]] && echo "âœ… OK" || echo "âŒ FALHA")"
          
          # Determinar resultado final
          if [[ "$TESTE_8081" == "200" && "$TESTE_PUBLICO" == "200" ]]; then
            echo ""
            echo "ğŸ‰ SUCESSO: Sistema funcionando corretamente!"
            exit 0
          else
            echo ""
            echo "ğŸš¨ FALHA: Sistema com problemas identificados!"
            exit 1
          fi

      - name: ğŸ§ª Teste adicional de mapeamento de controladores
        if: always()
        run: |
          echo "ğŸ” TESTE ESPECÃFICO: Mapeamento de controladores"
          echo "=============================================="
          
          SERVER_HOST="${{ secrets.SERVER_HOST }}"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          
          # FunÃ§Ã£o para executar comando SSH
          execute_ssh() {
            ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "$1"
          }
          
          echo "ğŸ“‹ Verificando logs de inicializaÃ§Ã£o do Spring..."
          execute_ssh "docker logs backend-teste 2>&1 | grep -E '(RequestMapping|Controller|mapping|handler|router)' | tail -10 || echo 'Nenhum log de mapeamento encontrado'"
          
          echo ""
          echo "ğŸ” Verificando se controladores estÃ£o sendo registrados..."
          execute_ssh "docker logs backend-teste 2>&1 | grep -E '(ConfiguracaoWebFluxControladores|RequestMappingHandlerMapping)' || echo 'ConfiguraÃ§Ã£o WebFlux nÃ£o encontrada nos logs'"
          
          echo ""
          echo "ğŸ§ª Testando endpoints especÃ­ficos..."
          
          # Teste endpoint JWK Set
          JWK_TEST=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/rest/.well-known/jwks.json || echo 'ERRO'")
          echo "JWK Set endpoint: $JWK_TEST"
          
          # Teste endpoint de resultados
          RESULTADOS_TEST=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/rest/v1/publico/resultados/hoje || echo 'ERRO'")
          echo "Resultados endpoint: $RESULTADOS_TEST"

          # Teste endpoint de estatÃ­sticas
          STATS_TEST=$(execute_ssh "curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/rest/v1/publico/estatisticas/resumo || echo 'ERRO'")
          echo "EstatÃ­sticas endpoint: $STATS_TEST"

      - name: ğŸ“¥ Obter logs do projeto
        if: always()
        run: |
          mkdir -p logs
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" \
            "docker logs --tail 200 backend-teste 2>&1" > logs/backend-teste.log
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" \
            "docker logs --tail 200 backend-prod 2>&1" > logs/backend-prod.log || true

      - name: ğŸ“¤ Enviar logs para o workflow
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-backend
          path: logs/*.log

      - name: ğŸ” Analisar causa da falha
        if: failure()
        run: .github/workflows/scripts/analisar-falha-127.sh logs/workflow.log
