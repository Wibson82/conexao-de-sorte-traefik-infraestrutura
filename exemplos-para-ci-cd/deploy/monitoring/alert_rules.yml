# ===== REGRAS DE ALERTAS - PROMETHEUS =====
# Sistema: Conex√£o de Sorte - Backend
# Fun√ß√£o: Defini√ß√£o de alertas para monitoramento proativo
# Vers√£o: 1.0.0
# Data: $(date +"%d/%m/%Y")

groups:
  # ===== ALERTAS CR√çTICOS =====
  - name: critical_alerts
    rules:
      # Aplica√ß√£o completamente down
      - alert: ApplicationDown
        expr: up{job=~"conexao-backend.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend
          team: devops
        annotations:
          summary: "üö® Aplica√ß√£o Conex√£o de Sorte est√° DOWN"
          description: "A aplica√ß√£o {{ $labels.job }} est√° inacess√≠vel h√° mais de 1 minuto."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Application-Down"
          action: "Verificar logs do container e reiniciar se necess√°rio"

      # Taxa de erro muito alta
      - alert: HighErrorRate
        expr: |
          (
            rate(http_server_requests_total{status=~"5.."}[5m]) /
            rate(http_server_requests_total[5m])
          ) * 100 > 5
        for: 2m
        labels:
          severity: critical
          service: backend
          team: devops
        annotations:
          summary: "üö® Taxa de erro cr√≠tica: {{ $value | humanizePercentage }}"
          description: "Taxa de erro HTTP 5xx acima de 5% nos √∫ltimos 5 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-High-Error-Rate"
          action: "Verificar logs de aplica√ß√£o e banco de dados"

      # Banco de dados inacess√≠vel
      - alert: DatabaseDown
        expr: up{job="mysql"} == 0
        for: 30s
        labels:
          severity: critical
          service: database
          team: devops
        annotations:
          summary: "üö® Banco de dados MySQL est√° DOWN"
          description: "MySQL est√° inacess√≠vel h√° mais de 30 segundos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Database-Down"
          action: "Verificar container MySQL e logs de banco"

      # Uso extremo de mem√≥ria
      - alert: CriticalMemoryUsage
        expr: |
          (
            jvm_memory_used_bytes{area="heap"} /
            jvm_memory_max_bytes{area="heap"}
          ) * 100 > 90
        for: 2m
        labels:
          severity: critical
          service: backend
          team: devops
        annotations:
          summary: "üö® Uso cr√≠tico de mem√≥ria: {{ $value | humanizePercentage }}"
          description: "Heap JVM acima de 90% h√° mais de 2 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Memory-Usage"
          action: "Verificar memory leaks e considerar restart"

      # Pool de conex√µes esgotado
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          (
            hikaricp_connections_active /
            hikaricp_connections_max
          ) * 100 > 95
        for: 1m
        labels:
          severity: critical
          service: database
          team: devops
        annotations:
          summary: "üö® Pool de conex√µes esgotado: {{ $value | humanizePercentage }}"
          description: "Pool de conex√µes MySQL acima de 95% h√° mais de 1 minuto."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Connection-Pool"
          action: "Verificar queries lentas e conex√µes ativas"

  # ===== ALERTAS DE WARNING =====
  - name: warning_alerts
    rules:
      # Lat√™ncia alta
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            rate(http_server_requests_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          service: backend
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Lat√™ncia alta: {{ $value }}s (P95)"
          description: "95% das requisi√ß√µes est√£o levando mais de 1 segundo."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-High-Latency"
          action: "Verificar performance de queries e cache"

      # Uso alto de mem√≥ria
      - alert: HighMemoryUsage
        expr: |
          (
            jvm_memory_used_bytes{area="heap"} /
            jvm_memory_max_bytes{area="heap"}
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: backend
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Uso alto de mem√≥ria: {{ $value | humanizePercentage }}"
          description: "Heap JVM acima de 80% h√° mais de 5 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Memory-Usage"
          action: "Monitorar crescimento e preparar para poss√≠vel restart"

      # Pool de conex√µes alto
      - alert: HighDatabaseConnections
        expr: |
          (
            hikaricp_connections_active /
            hikaricp_connections_max
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: database
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Uso alto do pool de conex√µes: {{ $value | humanizePercentage }}"
          description: "Pool de conex√µes MySQL acima de 80% h√° mais de 5 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Connection-Pool"
          action: "Monitorar queries ativas e otimizar se necess√°rio"

      # Garbage Collection frequente
      - alert: FrequentGarbageCollection
        expr: rate(jvm_gc_collection_seconds_count[5m]) > 0.2
        for: 5m
        labels:
          severity: warning
          service: backend
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Garbage Collection frequente: {{ $value }}/s"
          description: "GC executando mais de 0.2 vezes por segundo."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-GC-Performance"
          action: "Verificar configura√ß√µes de heap e memory leaks"

      # Taxa de erro moderada
      - alert: ModerateErrorRate
        expr: |
          (
            rate(http_server_requests_total{status=~"5.."}[5m]) /
            rate(http_server_requests_total[5m])
          ) * 100 > 1
        for: 5m
        labels:
          severity: warning
          service: backend
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Taxa de erro moderada: {{ $value | humanizePercentage }}"
          description: "Taxa de erro HTTP 5xx acima de 1% nos √∫ltimos 5 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Error-Rate"
          action: "Investigar logs para identificar causa dos erros"

  # ===== ALERTAS DE INFRAESTRUTURA =====
  - name: infrastructure_alerts
    rules:
      # Espa√ßo em disco baixo
      - alert: LowDiskSpace
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"} /
            node_filesystem_size_bytes{mountpoint="/"}
          ) * 100 < 20
        for: 5m
        labels:
          severity: warning
          service: infrastructure
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Espa√ßo em disco baixo: {{ $value | humanizePercentage }} dispon√≠vel"
          description: "Menos de 20% de espa√ßo dispon√≠vel no disco raiz."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Disk-Space"
          action: "Limpar logs antigos e verificar crescimento de dados"

      # CPU alta
      - alert: HighCPUUsage
        expr: |
          (
            100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          ) > 80
        for: 10m
        labels:
          severity: warning
          service: infrastructure
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Uso alto de CPU: {{ $value | humanizePercentage }}"
          description: "CPU acima de 80% h√° mais de 10 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-CPU-Usage"
          action: "Verificar processos consumindo CPU e otimizar"

      # Container reiniciando
      - alert: ContainerRestarting
        expr: rate(container_start_time_seconds[5m]) > 0
        for: 1m
        labels:
          severity: warning
          service: infrastructure
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Container reiniciando: {{ $labels.name }}"
          description: "Container {{ $labels.name }} reiniciou nos √∫ltimos 5 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Container-Restart"
          action: "Verificar logs do container para identificar causa"

  # ===== ALERTAS DE NEG√ìCIO =====
  - name: business_alerts
    rules:
      # Baixo volume de transa√ß√µes
      - alert: LowTransactionVolume
        expr: rate(http_server_requests_total{uri=~"/rest/.*"}[1h]) < 0.1
        for: 30m
        labels:
          severity: warning
          service: business
          team: product
        annotations:
          summary: "‚ö†Ô∏è Volume baixo de transa√ß√µes: {{ $value }}/s"
          description: "Menos de 0.1 transa√ß√µes por segundo na √∫ltima hora."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Transaction-Volume"
          action: "Verificar se h√° problemas de conectividade ou campanhas"

      # Falhas de autentica√ß√£o
      - alert: HighAuthenticationFailures
        expr: |
          rate(http_server_requests_total{status="401"}[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: security
          team: security
        annotations:
          summary: "‚ö†Ô∏è Falhas de autentica√ß√£o altas: {{ $value }}/s"
          description: "Mais de 0.5 falhas de autentica√ß√£o por segundo."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Auth-Failures"
          action: "Verificar tentativas de acesso n√£o autorizado"

  # ===== ALERTAS DE COMPLIANCE LGPD =====
  - name: lgpd_compliance_alerts
    rules:
      # Falhas no processamento de dados pessoais
      - alert: PersonalDataProcessingFailure
        expr: |
          rate(http_server_requests_total{uri=~"/rest/privacidade/.*",status=~"5.."}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          service: lgpd
          team: compliance
        annotations:
          summary: "üö® Falha no processamento de dados pessoais"
          description: "Erros nos endpoints de privacidade/LGPD detectados."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-LGPD-Compliance"
          action: "Verificar logs de privacidade e notificar DPO"

      # Volume alto de solicita√ß√µes de exclus√£o
      - alert: HighDataDeletionRequests
        expr: |
          rate(http_server_requests_total{uri=~"/rest/privacidade/exclusao.*"}[1h]) > 10
        for: 5m
        labels:
          severity: warning
          service: lgpd
          team: compliance
        annotations:
          summary: "‚ö†Ô∏è Volume alto de solicita√ß√µes de exclus√£o: {{ $value }}/h"
          description: "Mais de 10 solicita√ß√µes de exclus√£o por hora."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Data-Deletion"
          action: "Verificar padr√£o de solicita√ß√µes e notificar DPO"

  # ===== ALERTAS DE MONITORAMENTO =====
  - name: monitoring_alerts
    rules:
      # Prometheus perdendo dados
      - alert: PrometheusDataLoss
        expr: increase(prometheus_tsdb_symbol_table_size_bytes[1h]) < 0
        for: 5m
        labels:
          severity: warning
          service: monitoring
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Prometheus pode estar perdendo dados"
          description: "Poss√≠vel perda de dados no Prometheus detectada."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Prometheus-Data-Loss"
          action: "Verificar configura√ß√£o e espa√ßo em disco do Prometheus"

      # Grafana inacess√≠vel
      - alert: GrafanaDown
        expr: up{job="grafana"} == 0
        for: 2m
        labels:
          severity: warning
          service: monitoring
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Grafana est√° inacess√≠vel"
          description: "Grafana est√° down h√° mais de 2 minutos."
          runbook_url: "https://github.com/facilita-servicos/conexao-de-sorte-backend/wiki/Runbook-Grafana-Down"
          action: "Verificar container Grafana e depend√™ncias"

# ===== CONFIGURA√á√ïES GLOBAIS =====
# 
# Severidades:
# - critical: Requer a√ß√£o imediata (SLA impactado)
# - warning: Requer aten√ß√£o (poss√≠vel impacto futuro)
# - info: Informativo (sem a√ß√£o necess√°ria)
# 
# Teams:
# - devops: Infraestrutura e opera√ß√µes
# - product: Produto e neg√≥cio
# - security: Seguran√ßa e compliance
# - compliance: LGPD e regulamenta√ß√µes
# 
# Services:
# - backend: Aplica√ß√£o Spring Boot
# - database: MySQL
# - infrastructure: Sistema operacional
# - monitoring: Prometheus/Grafana
# - business: M√©tricas de neg√≥cio
# - lgpd: Compliance LGPD
# - security: Seguran√ßa
# 
# Runbooks:
# - Cada alerta deve ter um runbook com procedimentos
# - Links para wiki com passos de resolu√ß√£o
# - Comandos espec√≠ficos para diagn√≥stico
# - Escala√ß√£o em caso de falha na resolu√ß√£o