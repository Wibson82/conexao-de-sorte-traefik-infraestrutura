# ===== CONFIGURA칂츾O ALERTMANAGER =====
# Sistema: Conex칚o de Sorte - Backend
# Fun칞칚o: Gerenciamento e roteamento de alertas
# Vers칚o: 1.0.0
# Data: $(date +"%d/%m/%Y")

# ===== CONFIGURA칂칏ES GLOBAIS =====
global:
  # SMTP para envio de emails
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alertas@conexaodesorte.com.br'
  smtp_auth_username: 'alertas@conexaodesorte.com.br'
  smtp_auth_password: '${SMTP_PASSWORD}' # Configurar via Azure Key Vault
  smtp_require_tls: true
  
  # Slack webhook (configurar via Azure Key Vault)
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # Configura칞칫es de resolu칞칚o
  resolve_timeout: 5m

# ===== TEMPLATES =====
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ===== ROTEAMENTO DE ALERTAS =====
route:
  # Configura칞칫es padr칚o
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  
  # Rotas espec칤ficas
  routes:
    # ===== ALERTAS CR칈TICOS =====
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 15m
      routes:
        # Aplica칞칚o down - notifica칞칚o imediata
        - match:
            alertname: ApplicationDown
          receiver: 'application-down'
          group_wait: 0s
          repeat_interval: 5m
        
        # Banco down - notifica칞칚o imediata
        - match:
            alertname: DatabaseDown
          receiver: 'database-down'
          group_wait: 0s
          repeat_interval: 5m
        
        # LGPD compliance - notifica칞칚o para DPO
        - match:
            service: lgpd
          receiver: 'lgpd-compliance'
          group_wait: 0s
          repeat_interval: 30m
    
    # ===== ALERTAS DE WARNING =====
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h
      routes:
        # Infraestrutura
        - match:
            service: infrastructure
          receiver: 'infrastructure-alerts'
        
        # Neg칩cio
        - match:
            service: business
          receiver: 'business-alerts'
        
        # Seguran칞a
        - match:
            service: security
          receiver: 'security-alerts'
    
    # ===== ALERTAS DE MONITORAMENTO =====
    - match:
        service: monitoring
      receiver: 'monitoring-alerts'
      group_wait: 1m
      repeat_interval: 4h
    
    # ===== HOR츼RIO COMERCIAL vs FORA DO HOR츼RIO =====
    - match_re:
        severity: (critical|warning)
      receiver: 'business-hours'
      active_time_intervals:
        - business-hours
    
    - match_re:
        severity: critical
      receiver: 'after-hours-critical'
      active_time_intervals:
        - after-hours

# ===== INTERVALOS DE TEMPO =====
time_intervals:
  # Hor치rio comercial (Segunda a Sexta, 8h 맙 18h, hor치rio de Bras칤lia)
  - name: business-hours
    time_intervals:
      - times:
          - start_time: '08:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'America/Sao_Paulo'
  
  # Fora do hor치rio comercial
  - name: after-hours
    time_intervals:
      - times:
          - start_time: '18:01'
            end_time: '07:59'
        weekdays: ['monday:friday']
        location: 'America/Sao_Paulo'
      - times:
          - start_time: '00:00'
            end_time: '23:59'
        weekdays: ['saturday', 'sunday']
        location: 'America/Sao_Paulo'

# ===== INIBI칂칏ES =====
inhibit_rules:
  # Se aplica칞칚o est치 down, n칚o alertar sobre lat칡ncia/erros
  - source_match:
      alertname: ApplicationDown
    target_match_re:
      alertname: (HighLatency|HighErrorRate|ModerateErrorRate)
    equal: ['instance']
  
  # Se banco est치 down, n칚o alertar sobre pool de conex칫es
  - source_match:
      alertname: DatabaseDown
    target_match_re:
      alertname: (DatabaseConnectionPoolExhausted|HighDatabaseConnections)
    equal: ['instance']
  
  # Se h치 problemas cr칤ticos de mem칩ria, n칚o alertar sobre GC
  - source_match:
      alertname: CriticalMemoryUsage
    target_match:
      alertname: FrequentGarbageCollection
    equal: ['instance']

# ===== RECEIVERS (DESTINAT츼RIOS) =====
receivers:
  # ===== RECEIVER PADR츾O =====
  - name: 'default-receiver'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alertas-geral'
        title: '游댒 Alerta - Conex칚o de Sorte'
        text: |
          *Alerta:* {{ .GroupLabels.alertname }}
          *Severidade:* {{ .GroupLabels.severity }}
          *Servi칞o:* {{ .GroupLabels.service }}
          *Descri칞칚o:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        send_resolved: true
  
  # ===== ALERTAS CR칈TICOS =====
  - name: 'critical-alerts'
    email_configs:
      - to: 'devops@conexaodesorte.com.br'
        subject: '游뚿 CR칈TICO - {{ .GroupLabels.alertname }} - Conex칚o de Sorte'
        body: |
          ALERTA CR칈TICO DETECTADO!
          
          Alerta: {{ .GroupLabels.alertname }}
          Severidade: {{ .GroupLabels.severity }}
          Servi칞o: {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o Requerida: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          
          A칞칚o imediata necess치ria!
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alertas-criticos'
        title: '游뚿 CR칈TICO - {{ .GroupLabels.alertname }}'
        text: |
          <!channel> ALERTA CR칈TICO!
          
          *Alerta:* {{ .GroupLabels.alertname }}
          *Severidade:* {{ .GroupLabels.severity }}
          *Servi칞o:* {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *A칞칚o:* {{ .Annotations.action }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
        color: 'danger'
  
  # ===== APLICA칂츾O DOWN =====
  - name: 'application-down'
    email_configs:
      - to: 'devops@conexaodesorte.com.br,cto@conexaodesorte.com.br'
        subject: '游뚿 URGENTE - Aplica칞칚o DOWN - Conex칚o de Sorte'
        body: |
          APLICA칂츾O COMPLETAMENTE INACESS칈VEL!
          
          A aplica칞칚o Conex칚o de Sorte est치 completamente down.
          A칞칚o imediata necess치ria para restaurar o servi칞o.
          
          {{ range .Alerts }}
          Inst칙ncia: {{ .Labels.instance }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alertas-criticos'
        title: '游뚿 APLICA칂츾O DOWN'
        text: |
          <!channel> 游뚿 APLICA칂츾O COMPLETAMENTE DOWN! 游뚿
          
          A aplica칞칚o Conex칚o de Sorte est치 inacess칤vel.
          Interven칞칚o imediata necess치ria!
          
          {{ range .Alerts }}
          *Inst칙ncia:* {{ .Labels.instance }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
        color: 'danger'
  
  # ===== BANCO DOWN =====
  - name: 'database-down'
    email_configs:
      - to: 'devops@conexaodesorte.com.br,dba@conexaodesorte.com.br'
        subject: '游뚿 URGENTE - Banco de Dados DOWN - Conex칚o de Sorte'
        body: |
          BANCO DE DADOS INACESS칈VEL!
          
          O MySQL est치 down, impactando toda a aplica칞칚o.
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alertas-criticos'
        title: '游뚿 BANCO DOWN'
        text: |
          <!channel> 游뚿 BANCO DE DADOS DOWN! 游뚿
          
          MySQL inacess칤vel - aplica칞칚o impactada!
          
          {{ range .Alerts }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
        color: 'danger'
  
  # ===== LGPD COMPLIANCE =====
  - name: 'lgpd-compliance'
    email_configs:
      - to: 'dpo@conexaodesorte.com.br,compliance@conexaodesorte.com.br'
        subject: '游뚿 LGPD - Falha no Processamento de Dados Pessoais'
        body: |
          ALERTA DE COMPLIANCE LGPD!
          
          Detectada falha no processamento de dados pessoais.
          Notifica칞칚o obrigat칩ria conforme LGPD.
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          
          DPO deve ser notificado imediatamente.
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#compliance-lgpd'
        title: '游뚿 LGPD - Falha no Processamento'
        text: |
          <!channel> 游뚿 ALERTA LGPD! 游뚿
          
          Falha no processamento de dados pessoais detectada.
          DPO deve ser notificado.
          
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
        color: 'danger'
  
  # ===== ALERTAS DE WARNING =====
  - name: 'warning-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alertas-warning'
        title: '丘멆잺 Warning - {{ .GroupLabels.alertname }}'
        text: |
          *Alerta:* {{ .GroupLabels.alertname }}
          *Severidade:* {{ .GroupLabels.severity }}
          *Servi칞o:* {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *A칞칚o:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # ===== INFRAESTRUTURA =====
  - name: 'infrastructure-alerts'
    email_configs:
      - to: 'devops@conexaodesorte.com.br'
        subject: '丘멆잺 Infraestrutura - {{ .GroupLabels.alertname }}'
        body: |
          Alerta de infraestrutura detectado.
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#infraestrutura'
        title: '丘멆잺 Infraestrutura - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *A칞칚o:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # ===== NEG칍CIO =====
  - name: 'business-alerts'
    email_configs:
      - to: 'product@conexaodesorte.com.br,business@conexaodesorte.com.br'
        subject: '丘멆잺 Neg칩cio - {{ .GroupLabels.alertname }}'
        body: |
          Alerta de m칠tricas de neg칩cio detectado.
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#metricas-negocio'
        title: '丘멆잺 Neg칩cio - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *A칞칚o:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # ===== SEGURAN칂A =====
  - name: 'security-alerts'
    email_configs:
      - to: 'security@conexaodesorte.com.br,devops@conexaodesorte.com.br'
        subject: '丘멆잺 Seguran칞a - {{ .GroupLabels.alertname }}'
        body: |
          Alerta de seguran칞a detectado.
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#seguranca'
        title: '丘멆잺 Seguran칞a - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *A칞칚o:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # ===== MONITORAMENTO =====
  - name: 'monitoring-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#monitoramento'
        title: '丘멆잺 Monitoramento - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *A칞칚o:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # ===== HOR츼RIO COMERCIAL =====
  - name: 'business-hours'
    email_configs:
      - to: 'devops@conexaodesorte.com.br'
        subject: '游댒 Alerta - {{ .GroupLabels.alertname }} (Hor치rio Comercial)'
        body: |
          Alerta durante hor치rio comercial.
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alertas-geral'
        title: '游댒 {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
  
  # ===== FORA DO HOR츼RIO - APENAS CR칈TICOS =====
  - name: 'after-hours-critical'
    email_configs:
      - to: 'oncall@conexaodesorte.com.br'
        subject: '游뚿 CR칈TICO - {{ .GroupLabels.alertname }} (Fora do Hor치rio)'
        body: |
          ALERTA CR칈TICO FORA DO HOR츼RIO COMERCIAL!
          
          {{ range .Alerts }}
          Descri칞칚o: {{ .Annotations.description }}
          A칞칚o: {{ .Annotations.action }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          
          Plant칚o deve ser acionado.
        send_resolved: true
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#plantao'
        title: '游뚿 CR칈TICO - {{ .GroupLabels.alertname }}'
        text: |
          <!channel> 游뚿 CR칈TICO FORA DO HOR츼RIO! 游뚿
          
          {{ range .Alerts }}
          *Descri칞칚o:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
        color: 'danger'

# ===== CONFIGURA칂칏ES ADICIONAIS =====
# 
# Vari치veis de ambiente necess치rias:
# - SMTP_PASSWORD: Senha do email de alertas (Azure Key Vault)
# - SLACK_WEBHOOK_URL: URL do webhook do Slack (Azure Key Vault)
# 
# Canais Slack recomendados:
# - #alertas-geral: Alertas gerais
# - #alertas-criticos: Alertas cr칤ticos
# - #alertas-warning: Alertas de warning
# - #infraestrutura: Alertas de infraestrutura
# - #metricas-negocio: Alertas de neg칩cio
# - #seguranca: Alertas de seguran칞a
# - #compliance-lgpd: Alertas LGPD
# - #monitoramento: Alertas do pr칩prio monitoramento
# - #plantao: Alertas cr칤ticos fora do hor치rio
# 
# Emails recomendados:
# - devops@conexaodesorte.com.br: Equipe DevOps
# - dpo@conexaodesorte.com.br: Data Protection Officer
# - compliance@conexaodesorte.com.br: Equipe de Compliance
# - security@conexaodesorte.com.br: Equipe de Seguran칞a
# - product@conexaodesorte.com.br: Equipe de Produto
# - business@conexaodesorte.com.br: Equipe de Neg칩cio
# - oncall@conexaodesorte.com.br: Plant칚o 24x7
# - cto@conexaodesorte.com.br: CTO
# - dba@conexaodesorte.com.br: DBA