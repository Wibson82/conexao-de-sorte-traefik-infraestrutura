Current runner version: '2.328.0'
Runner name: 'srv649924'
Runner group name: 'Default'
Machine name: 'srv649924'
GITHUB_TOKEN Permissions
Secret source: Actions
Prepare workflow directory
Prepare all required actions
Getting action download info
Download action repository 'actions/checkout@v4.3.0' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)
Download action repository 'actions/download-artifact@v4.1.8' (SHA:fa0a91b85d4f404e444e00e005971372dc801d16)
Complete job name: deploy-selfhosted
1s
Run actions/checkout@v4.3.0
Syncing repository: Wibson82/conexao-de-sorte-traefik-infraestrutura
Getting Git version info
Temporarily overriding HOME='/home/runner/actions-runner/conexao-de-sorte-traefik-infraestrutura/_work/_temp/58053101-440c-46c4-9adf-bd47989f470c' before making global git config changes
Adding repository directory to the temporary git global config as a safe directory
/usr/bin/git config --global --add safe.directory /home/runner/actions-runner/conexao-de-sorte-traefik-infraestrutura/_work/conexao-de-sorte-traefik-infraestrutura/conexao-de-sorte-traefik-infraestrutura
/usr/bin/git config --local --get remote.origin.url
https://github.com/Wibson82/conexao-de-sorte-traefik-infraestrutura
Removing previously created refs, to avoid conflicts
/usr/bin/git submodule status
Cleaning the repository
Disabling automatic garbage collection
Setting up auth
Fetching the repository
Determining the checkout info
/usr/bin/git sparse-checkout disable
/usr/bin/git config --local --unset-all extensions.worktreeConfig
Checking out the ref
/usr/bin/git log -1 --format=%H
10ee41a9c87ab6247beab32e132e6df8400650d7
2s
Run actions/download-artifact@v4.1.8
Downloading single artifact
Preparing to download the following artifacts:
- traefik-configs (ID: 4039224478, Size: 11397)
Redirecting to blob download url: https://productionresultssa7.blob.core.windows.net/actions-results/fa4d54c0-4ce5-419b-95be-74119a324682/workflow-job-run-99822d65-0eaf-577a-9438-845784676345/artifacts/79f6df28388fa0095051f171d314a6f3e2f4b5cf91d775bf6f424a97bf621c62.zip
Starting download of artifact to: /home/runner/actions-runner/conexao-de-sorte-traefik-infraestrutura/_work/conexao-de-sorte-traefik-infraestrutura/conexao-de-sorte-traefik-infraestrutura
(node:106937) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
Artifact download completed successfully.
Total of 1 artifact(s) downloaded
Download artifact has finished successfully
0s
Run # Criar secrets Docker se não existirem (ambiente limpo)
ℹ️  � Criando Docker Secrets obrigatórios para Traefik...

✅ Docker Swarm ativo, prosseguindo com criação de secrets...

ℹ️  Criando secrets CRÍTICOS:
⚠️  CORS_ALLOWED_ORIGINS: Já existe, pulando criação
⚠️  SSL_ENABLED: Já existe, pulando criação
⚠️  SSL_KEYSTORE_PASSWORD: Já existe, pulando criação
⚠️  JWT_VERIFICATION_KEY: Já existe, pulando criação

ℹ️  Criando secrets OPCIONAIS:
⚠️  CORS_ALLOW_CREDENTIALS: Já existe, pulando criação
⚠️  SSL_KEYSTORE_PATH: Já existe, pulando criação
⚠️  JWT_SIGNING_KEY: Já existe, pulando criação

ℹ️  � Listando todos os secrets criados:
NAME                     CREATED        UPDATED
CORS_ALLOWED_ORIGINS     19 hours ago   19 hours ago
CORS_ALLOW_CREDENTIALS   19 hours ago   19 hours ago
DATABASE_PASSWORD        17 hours ago   17 hours ago
JWT_SIGNING_KEY          2 hours ago    2 hours ago
JWT_VERIFICATION_KEY     2 hours ago    2 hours ago
RABBITMQ_PASSWORD        17 hours ago   17 hours ago
RABBITMQ_USERNAME        19 hours ago   19 hours ago
SSL_ENABLED              19 hours ago   19 hours ago
SSL_KEYSTORE_PASSWORD    19 hours ago   19 hours ago
SSL_KEYSTORE_PATH        19 hours ago   19 hours ago

✅ � Todos os secrets Docker foram criados com sucesso!
ℹ️  ✅ Traefik agora pode ser deployado sem erros de secrets
ℹ️  � Iniciando validação completa de secrets para Traefik...

ℹ️  Validando Docker Secrets críticos para Traefik (OIDC-Only)...
ℹ️  Verificando secrets CRÍTICOS:
✅ CORS_ALLOWED_ORIGINS: Disponível
✅ SSL_ENABLED: Disponível
✅ SSL_KEYSTORE_PASSWORD: Disponível
✅ JWT_VERIFICATION_KEY: Disponível
✅ Todos os secrets críticos para Traefik estão disponíveis

ℹ️  Verificando secrets OPCIONAIS:
✅ CORS_ALLOW_CREDENTIALS: Disponível (opcional)
✅ SSL_KEYSTORE_PATH: Disponível (opcional)
✅ JWT_SIGNING_KEY: Disponível (opcional)

ℹ️  Validando configurações Azure Key Vault...
✅ AZURE_CLIENT_ID: Configurado
✅ AZURE_TENANT_ID: Configurado
✅ AZURE_KEYVAULT_ENDPOINT: Configurado
✅ Todas as variáveis Azure Key Vault estão configuradas

✅ � Validação de secrets concluída com sucesso!
ℹ️  ✅ Traefik está pronto para deploy seguro
0s
Run chmod +x .github/workflows/scripts/deploy-traefik.sh .github/workflows/scripts/healthcheck-traefik.sh .github/workflows/scripts/connectivity-validation.sh .github/workflows/scripts/create-docker-secrets.sh
12s
Run echo "� Iniciando deploy do Traefik com Docker Swarm..."
� Iniciando deploy do Traefik com Docker Swarm...
� Preparing environment for Traefik deploy...
✅ Usando arquivo especificado: docker-compose.yml
� Usando Docker Swarm mode com docker-compose.yml
� Checking Docker Swarm overlay network: conexao-network-swarm
✅ Network conexao-network-swarm already exists
� Configurando diretórios e arquivos necessários...
� Diretório de trabalho: /home/runner/actions-runner/conexao-de-sorte-traefik-infraestrutura/_work/conexao-de-sorte-traefik-infraestrutura/conexao-de-sorte-traefik-infraestrutura
�️ Criando diretórios...
✅ Todos os diretórios criados
� Configurando arquivo acme.json...
✅ Arquivo acme.json configurado com permissões 600
� Deploying Traefik stack: conexao-traefik using docker-compose.yml
Ignoring unsupported options: restart

Since --detach=false was not specified, tasks will be created in the background.
In a future release, --detach=false will become the default.
Updating service conexao-traefik_traefik (id: bsk2pp27shzzn8elofhorc439)
✅ Stack conexao-traefik deployed successfully!
⏳ Aguardando serviços ficarem prontos...
� Verificando status do deployment...
ID                          NAME                            IMAGE                                                                                    NODE        DESIRED STATE   CURRENT STATE             ERROR                         PORTS
tkqo19brxtfhbrbl9j3dxeeos   conexao-traefik_traefik.1       traefik:v3.5.2@sha256:f0abbbd11ced29754d4d188c29e9320b613481ec162b6ea5d3a8b6bdd8e5fa54   srv649924   Shutdown        Complete 11 minutes ago
yw3siryopdjnqi98k9sc842f6    \_ conexao-traefik_traefik.1   traefik:v3.5.2@sha256:f0abbbd11ced29754d4d188c29e9320b613481ec162b6ea5d3a8b6bdd8e5fa54   srv649924   Shutdown        Failed 2 hours ago        "task: non-zero exit (255)"
� Verificando serviços do stack...
ID             NAME                      MODE         REPLICAS   IMAGE            PORTS
bsk2pp27shzz   conexao-traefik_traefik   replicated   0/1        traefik:v3.5.2   *:80->80/tcp, *:443->443/tcp
✅ Deploy do Traefik finalizado com sucesso!
� Traefik Dashboard: https://conexaodesorte.com.br/traefik
� APIs: https://conexaodesorte.com.br/rest/*
0s
2m 1s
Run .github/workflows/scripts/connectivity-validation.sh
� Iniciando validação de conectividade do Traefik...

� [1/6] Verificações pré-deploy...
✅ Docker Swarm ativo
✅ Rede conexao-network-swarm existe

� [2/6] Validação do deploy do serviço...
ℹ️  Aguardando: Serviço conexao-traefik_traefik criado...
✅ Serviço conexao-traefik_traefik criado - OK (0 segundos)
ℹ️  Aguardando: Serviço conexao-traefik_traefik com réplicas 1/1...
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (0/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (5/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (10/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (15/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (20/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (25/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (30/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (35/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (40/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (45/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (50/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (55/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (60/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (65/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (70/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (75/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (80/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (85/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (90/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (95/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (100/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (105/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (110/120 segundos)
⏳ Serviço conexao-traefik_traefik com réplicas 1/1... (115/120 segundos)
❌ Serviço conexao-traefik_traefik com réplicas 1/1 - TIMEOUT após 120 segundos
Error: Process completed with exit code 1.
